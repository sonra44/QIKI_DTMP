# hot_test_statestore.sh

## Вход и цель
- [Факт] Комплексный HOT TEST скрипт для проверки архитектуры `StateStore`.
- [Гипотеза] Используется перед интеграцией нового стора в основную систему.

## Сбор контекста
- [Факт] Использует строгий режим `set -euo pipefail` и цветной вывод【F:scripts/hot_test_statestore.sh†L1-L21】.
- [Факт] Проверяет окружение: наличие модулей `types.py`, `store.py`, `conv.py`, а также зависимостей `pytest`, `asyncio`, `psutil`【F:scripts/hot_test_statestore.sh†L23-L52】.
- [Факт] Выполняет синтаксическую проверку модулей и тестирует импорты【F:scripts/hot_test_statestore.sh†L56-L93】.
- [Факт] Запускает unit‑тесты для StateStore и дополнительные проверки (integration, stress, compatibility, performance)【F:scripts/hot_test_statestore.sh†L95-L120】.
- [Гипотеза] Скрипт генерирует отчёт в `reports/HOT_TEST_REPORT.md` (по содержанию функции `generate_report`).

## Локализация артефакта
- [Факт] Расположение: `scripts/hot_test_statestore.sh`.
- [Факт] Окружение: Linux/macOS, Python3 с тестовыми зависимостями и инструментами мониторинга.

## Фактический разбор
1. [Факт] Функции `check_environment`, `syntax_check`, `import_check` обеспечивают базовые гарантии корректности.
2. [Факт] `run_unit_tests` последовательно выполняет тесты из `services/q_core_agent/state/tests/`.
3. [Факт] Основная функция `main` комбинирует критичные и дополнительные проверки, измеряя время выполнения.
4. [Гипотеза] Отчёт содержит системную информацию и рекомендации.
5. [Гипотеза] Дополнительные функции (stress, performance) могут отсутствовать или быть частично реализованы.

## Роль в системе и связи
- [Факт] Валидирует целостность подсистемы StateStore перед включением в QIKI.
- [Гипотеза] Может быть частью CI, но требует длительного времени выполнения.

## Несоответствия и риски
- [Гипотеза] Большое количество зависимостей и длительные тесты усложняют использование (Med).
- [Гипотеза] Нет явного указания, куда сохраняется отчёт (Low).

## Мини-патчи (safe-fix)
- [Патч] Явно прописать путь отчёта и выводить его по завершении.
- [Патч] Добавить параметр `--no-color` для запуска в CI без ANSI кодов.

## Рефактор-скетч
```bash
#!/usr/bin/env bash
set -euo pipefail
check_environment && syntax_check && import_check
python3 -m pytest services/q_core_agent/state/tests -v
```

## Примеры использования
```bash
bash scripts/hot_test_statestore.sh
bash scripts/hot_test_statestore.sh --quick
```

## Тест-хуки/чек-лист
- [ ] Все модули `state` компилируются без ошибок.
- [ ] Импорты `FsmSnapshotDTO` и `AsyncStateStore` успешны.
- [ ] Unit‑тесты пройдены.
- [ ] Отчёт HOT TEST сохранён и содержит метрики производительности.

## Вывод
- [Факт] Скрипт обеспечивает глубокую проверку StateStore.
- [Патч] Требует упрощения и параметров для CI.
