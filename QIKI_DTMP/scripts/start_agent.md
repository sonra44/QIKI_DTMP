# start_agent.sh

## Вход и цель
- [Факт] Скрипт запускает `Q-Core Agent` с поддержкой gRPC.
- [Гипотеза] Используется разработчиком для локального теста или запуска демо.

## Сбор контекста
- [Факт] Проверяет наличие Python и библиотеки `grpc`【F:scripts/start_agent.sh†L12-L22】.
- [Факт] При отсутствии сгенерированных protobuf‑файлов запускает `grpc_tools.protoc`【F:scripts/start_agent.sh†L24-L32】.
- [Факт] Выполняет проверку доступности `Q-Sim` сервера через gRPC‑запрос `HealthCheck`【F:scripts/start_agent.sh†L34-L53】.
- [Факт] Запускает `services/q_core_agent/main.py --grpc`【F:scripts/start_agent.sh†L56-L58】.
- [Гипотеза] Скрипт предполагает, что симулятор слушает `localhost:50051`.

## Локализация артефакта
- [Факт] Расположение: `scripts/start_agent.sh`.
- [Факт] Окружение: Linux/macOS, установлен Python3, gRPC, `grpc_tools`.

## Фактический разбор
1. [Факт] Инициализация переменных путей.
2. [Факт] Проверка зависимостей и генерация `.pb2` файлов.
3. [Факт] Проверка связи с симулятором.
4. [Факт] Запуск агента с флагом `--grpc`.
5. [Гипотеза] Нет graceful shutdown и обработки сигналов.

## Роль в системе и связи
- [Факт] Запускает центральный сервис платформы и требует работающий симулятор.
- [Гипотеза] Может быть частью сценария `run_qiki_demo.sh`.

## Несоответствия и риски
- [Гипотеза] Отсутствует проверка версии gRPC‑API (Med).
- [Гипотеза] Скрипт завершает работу при любом исключении без логов (Low).

## Мини-патчи (safe-fix)
- [Патч] Добавить проверку доступности `grpc_tools.protoc`.
- [Патч] Обрабатывать `SIGINT` для корректного завершения агента.

## Рефактор-скетч
```bash
#!/bin/bash
set -e
trap 'kill $PID' INT
python3 services/q_core_agent/main.py --grpc &
PID=$!; wait $PID
```

## Примеры использования
```bash
bash scripts/start_agent.sh
```

## Тест-хуки/чек-лист
- [ ] gRPC‑зависимости установлены.
- [ ] `Q-Sim` отвечает на `HealthCheck`.
- [ ] Агент завершился корректно.

## Вывод
- [Факт] Скрипт автоматизирует подготовку и запуск агента.
- [Патч] Добавить проверки версий и обработку сигналов для надёжности.
