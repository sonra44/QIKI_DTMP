# Отчет: qiki_mission_control_ultimate.py

## Вход и цель
- [Факт] Анализ модуля `qiki_mission_control_ultimate.py`; цель — сформировать технический отчёт и рекомендации.

## Сбор контекста
- [Факт] Изучены зависимости `prompt_toolkit`, `ship_core`, `ship_actuators`, `test_ship_fsm`.
- [Гипотеза] Модуль демонстрирует полноэкранный интерфейс для реального терминала.

## Локализация артефакта
- [Факт] Путь: `QIKI_DTMP/services/q_core_agent/core/qiki_mission_control_ultimate.py`.
- [Факт] Запуск: `python qiki_mission_control_ultimate.py` при наличии `prompt_toolkit`.

## Фактический разбор
- [Факт] Класс `QIKIMissionControlUltimate` строит UI через `prompt_toolkit` и ведёт журнал событий.
- [Факт] Фоновый поток `_background_simulation` обновляет телеметрию и параметры миссии.
- [Факт] При отсутствии `prompt_toolkit` пытается установить пакет во время выполнения.
- [Гипотеза] Автоустановка библиотек может быть неприемлема в продакшене.

## Роль в системе и связи
- [Факт] Предоставляет расширенный интерфейс управления кораблём с разделами SENSORS/POWER/DIAG.
- [Гипотеза] Используется операторами для мониторинга в реальном времени.

## Несоответствия и риски
- [Гипотеза][High] Автоустановка зависимостей без подтверждения может нарушить безопасность окружения.
- [Гипотеза][Med] Отсутствие обработки ошибок при создании потоков и UI-приложения.

## Мини-патчи (safe-fix)
- [Патч] Удалить автоматическую установку `prompt_toolkit`; вместо этого выдавать инструкцию пользователю.
- [Патч] Добавить таймер остановки для фонового потока при закрытии приложения.

## Рефактор-скетч (по желанию)
```python
class QIKIMissionControlUltimate:
    def __init__(self, core: ShipCore, actuators: ShipActuatorController):
        self.ship_core = core
        self.actuator_controller = actuators
```

## Примеры использования
- [Факт]
```bash
python qiki_mission_control_ultimate.py
```
- [Гипотеза]
```python
ultimate = QIKIMissionControlUltimate()
ultimate.current_view = "POWER"
```

## Тест-хуки/чек-лист
- [Факт] Проверить корректность отображения журнала событий при переключении вкладок.
- [Гипотеза] Симулировать отказ `prompt_toolkit` и убедиться, что программа завершает работу контролируемо.

## Вывод
- [Факт] Модуль реализует богатый терминальный интерфейс для управления миссией.
- [Патч] Рекомендуется убрать автоустановку зависимостей и добавить управление жизненным циклом фоновых потоков; расширенный рефакторинг интерфейса можно выполнить позднее.
