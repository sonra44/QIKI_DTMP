# Отчет: rule_engine.py

## Вход и цель
- [Факт] Анализ файла `rule_engine.py`; задача — описать текущую логику и выявить улучшения.

## Сбор контекста
- [Факт] Модуль зависит от интерфейса `IRuleEngine`, `AgentContext` и protobuf-сообщений.
- [Гипотеза] Расширение правил будет происходить по мере добавления новых датчиков.

## Локализация артефакта
- [Факт] Путь: `QIKI_DTMP/services/q_core_agent/core/rule_engine.py`.
- [Факт] Использование: импорт в агенте, вызов `generate_proposals(context)`.

## Фактический разбор
- [Факт] Класс `RuleEngine` реализует метод `generate_proposals`.
- [Факт] Единственное правило: при `not context.is_bios_ok()` формируется предложение перейти в `SAFE_MODE`.
- [Гипотеза] При расширении набора правил может потребоваться система приоритизации.

## Роль в системе и связи
- [Факт] Генерирует предложения действий для исполнительных модулей.
- [Гипотеза] Используется как один из источников решений наряду с планировщиком миссии.

## Несоответствия и риски
- [Гипотеза][Med] Отсутствует проверка валидности `context`; возможен `AttributeError` при `None`.
- [Гипотеза][Low] Логика фиксирована и не учитывает уровни серьёзности ошибок BIOS.

## Мини-патчи (safe-fix)
- [Патч] Добавить проверку `if context is None: return []` в `generate_proposals`.
- [Патч] Вынести создание `Timestamp` в отдельную функцию для упрощения тестирования.

## Рефактор-скетч (по желанию)
```python
def generate_proposals(self, context):
    if context.is_bios_ok():
        return []
    return [build_safe_mode_proposal()]
```

## Примеры использования
- [Факт]
```python
engine = RuleEngine(ctx, {})
proposals = engine.generate_proposals(ctx)
```
- [Гипотеза]
```python
if proposals:
    actuator.apply(proposals[0])
```

## Тест-хуки/чек-лист
- [Факт] Подставить фиктивный `context` с `is_bios_ok=False` и проверить создание предложения.
- [Гипотеза] Проверить, что при `context=None` метод возвращает пустой список.

## Вывод
- [Факт] RuleEngine пока содержит одно защитное правило.
- [Патч] Стоит добавить проверки входных данных и подготовить каркас для расширения правил; масштабирование системы можно реализовать позднее.
