# Отчет: ship_bios_handler.py

## Вход и цель
- [Факт] Анализ модуля `ship_bios_handler.py`; цель — описать диагностику подсистем и выявить риски.

## Сбор контекста
- [Факт] Модуль опирается на `ShipCore` и protobuf-тип `BiosStatusReport`.
- [Гипотеза] Используется в процессе POST-проверок корабля.

## Локализация артефакта
- [Факт] Путь: `QIKI_DTMP/services/q_core_agent/core/ship_bios_handler.py`.
- [Факт] Вызов: `ShipBiosHandler.process_bios_status(report)` возвращает обновлённый отчёт.

## Фактический разбор
- [Факт] `ShipBiosHandler` проводит шесть диагностик: корпус, энергосистема, двигатели, сенсоры, жизнеобеспечение, вычислительные блоки.
- [Факт] Результаты собираются в `updated_bios_status.post_results` с кодами ошибок.
- [Факт] `health_score` умножается на коэффициенты по результатам проверок.
- [Гипотеза] Частое использование `hasattr` и динамических полей может скрывать ошибки типов.

## Роль в системе и связи
- [Факт] Обеспечивает централизованную диагностику корабля для принятия решений RuleEngine.
- [Гипотеза] Может вызываться периодически в ходе миссии для оценки состояния.

## Несоответствия и риски
- [Гипотеза][High] Отсутствует защита от `None` в `ship_core`, что приведёт к сбою диагностики.
- [Гипотеза][Med] Коды ошибок задаются строками; возможно несоответствие с enum `StatusCode`.

## Мини-патчи (safe-fix)
- [Патч] Добавить проверку и логирование при `ship_core is None`.
- [Патч] Использовать `DeviceStatus.StatusCode` напрямую вместо строковых значений.

## Рефактор-скетч (по желанию)
```python
issues = self._diagnose_power_systems()
for issue in issues:
    updated_bios_status.post_results.append(build_device_status(issue))
```

## Примеры использования
- [Факт]
```python
handler = ShipBiosHandler(core)
report = handler.process_bios_status(BiosStatusReport())
```
- [Гипотеза]
```python
if not report.all_systems_go:
    trigger_safe_mode()
```

## Тест-хуки/чек-лист
- [Факт] Подставить деградированный `HullStatus` и проверить генерацию предупреждений.
- [Гипотеза] Имитация отсутствия `ship_core` должна приводить к безопасному возврату.

## Вывод
- [Факт] Модуль выполняет обширную диагностику всех подсистем корабля.
- [Патч] Следует добавить проверки входных данных и унифицировать коды ошибок; расширение логики диагностики можно выполнить позже.
