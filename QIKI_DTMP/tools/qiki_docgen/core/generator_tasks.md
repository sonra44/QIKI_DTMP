# Анализ `generator.py`

## Вход и цель
- [Факт] Требуется обзор модуля генерации артефактов (`generator.py`), итог — выявить задачи и безопасные правки.

## Сбор контекста
- [Факт] Исходник использует `Jinja2`, `ProtoParser`, `DesignDocParser`, `config` и `subprocess` для работы с `protoc`.
- [Гипотеза] Модуль вызывается CLI-утилитой, формируя дизайн-документы и контракты.

## Локализация артефакта
- [Факт] Путь: `tools/qiki_docgen/core/generator.py`.
- [Факт] Окружение: Python 3.11+, внешний `protoc`, Jinja2-шаблоны в `templates/`.

## Фактический разбор
- [Факт] `_get_paths()` и `_get_jinja_env()` готовят конфигурацию и шаблонное окружение.
- [Факт] `to_snake_case()` преобразует имя компонента к `snake_case`.
- [Факт] `create_design_document()` и `create_proto_contract()` генерируют файлы из шаблонов с режимом `dry_run`.
- [Факт] `compile_protos()` вызывает `protoc`, очищая и создавая каталог `generated`.
- [Факт] `build_readme()` сканирует дизайн-доки и `.proto` файлы, собирая общий `README.md`.

## Роль в системе и связи
- [Факт] Модуль orchestrates весь поток генерации артефактов.
- [Гипотеза] Используется при создании новых компонентов и обновлении документации.

## Несоответствия и риски
- [Гипотеза][Med] Отсутствие проверки успешности записи файлов может скрыть ошибки ввода/вывода.
- [Гипотеза][Low] При `shutil.rmtree` возможно удаление неожиданных путей при неверной конфигурации.

## Мини-патчи (safe-fix)
- [Патч] Добавить явный возврат статуса в функции создания файлов для раннего выявления ошибок.
- [Патч] Логировать полный путь при удалении каталога `generated`.

## Рефактор-скетч
```python
# Псевдокод архитектуры
paths = load_config()
with jinja_env(paths['template_dir']):
    design = render_design(component)
    proto = render_proto(component)
compile_protos(paths, flags)
assemble_readme(paths)
```

## Примеры использования
```python
from tools.qiki_docgen.core.generator import create_proto_contract
create_proto_contract("UserProfile", dry_run=True)
```

## Тест-хуки/чек-лист
- [ ] Юнит-тест `to_snake_case` с разными форматами имён.
- [ ] Интеграционный тест `compile_protos` с отсутствующим `protoc` (ожидается ошибка).
- [ ] Проверка `build_readme` на корректное включение всех компонентов.

## Вывод
- Модуль готовит шаблоны и компиляцию; критично контролировать операции с файлами и `protoc`.
- Сразу исправить: расширить логирование и проверку результатов.
- Отложить: проработку стратегии отката при сбоях.
