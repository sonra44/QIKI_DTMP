# Анализ `parser.py`

## Вход и цель
- [Факт] Необходимо проанализировать модуль парсинга протоколов и дизайн-доков.

## Сбор контекста
- [Факт] Модуль использует `re`, `Path`, `logging` и работает без внешних зависимостей.
- [Гипотеза] Предполагается использование внутри генератора при сборке README.

## Локализация артефакта
- [Факт] Путь: `tools/qiki_docgen/core/parser.py`.
- [Факт] Окружение: Python 3.11+, чтение файлов из файловой системы.

## Фактический разбор
- [Факт] `ProtoParser` извлекает `package`, `messages`, `enums`, `services` и комментарии перед ними.
- [Факт] `DesignDocParser` делит документ на YAML-frontmatter и секции, определяет `component_name`.
- [Факт] Поддерживаются поля, enum-значения и RPC-методы через регулярные выражения.

## Роль в системе и связи
- [Факт] Предоставляет структуру для дальнейшей генерации документации.
- [Гипотеза] Может использоваться в валидации входящих `.proto` и `design.md` файлов.

## Несоответствия и риски
- [Гипотеза][Med] Регулярные выражения не учитывают вложенные сообщения, возможен пропуск сложных структур.
- [Гипотеза][Low] Отсутствует ограничение по размеру файла — риск OOM при парсинге больших документов.

## Мини-патчи (safe-fix)
- [Патч] Добавить ограничение глубины поиска для сообщений и enum-значений.
- [Патч] Возвращать статистику (количество найденных элементов) для метрик.

## Рефактор-скетч
```python
class ProtoParser:
    def parse(self, path):
        text = path.read_text()
        return extract_structures(text)
```

## Примеры использования
```python
from tools.qiki_docgen.core.parser import ProtoParser
ProtoParser().parse_proto_file(Path("example.proto"))
```

## Тест-хуки/чек-лист
- [ ] Тесты на корректное извлечение комментариев перед элементами.
- [ ] Парсинг `.proto` с вложенными сообщениями — ожидается уведомление о пропуске.
- [ ] Проверка `DesignDocParser` на документах без frontmatter.

## Вывод
- Модуль охватывает базовые сценарии парсинга, но возможны ограничения регулярных выражений.
- Сразу улучшить: добавить метрики и ограничения глубины.
- Отложить: поддержку вложенных структур и стримингового парсинга.
