# services/q_core_agent/state/tests/test_store.py — анализ по методу «Задачи»

## Назначение файла
Базовые, pub/sub, конкурентные и метрические тесты для `AsyncStateStore`.

## Основные блоки задач
### 1. `TestAsyncStateStoreBasics`
- [ ] Пустой стор возвращает `None` при `get`.
- [ ] `set/get` сохраняют снапшот без изменения исходного DTO.
- [ ] Автоинкремент версий и проверка конфликтов (`StateVersionError`).
- [ ] Ошибка при попытке `set(None)`.
- [ ] `get_with_meta` возвращает метрики и текущее состояние.

### 2. `TestAsyncStateStorePubSub`
- [ ] Подписчик получает начальное состояние и обновления.
- [ ] Поддержка нескольких подписчиков и отписка.
- [ ] Обработка переполнения очереди.
- [ ] Очистка «мёртвых» подписчиков.

### 3. `TestAsyncStateStoreConcurrency`
- [ ] Конкурентные чтения и записи.
- [ ] Подписка/отписка в многопоточном режиме.
- [ ] Смешанный стресс из чтений, записей и подписок.

### 4. `TestAsyncStateStoreMetrics`
- [ ] Базовые метрики: `total_sets`, `total_gets`, состояние и версия.
- [ ] Обновление метрик после операций.
- [ ] Учёт конфликтов версий.
- [ ] `health_check` и сценарий с множеством проблем.

## Наблюдения и рекомендации
- Для корректного запуска требуется `pytest-asyncio`.
- Метрики помогают отслеживать ресурсы и ошибки; стоит расширить покрытие тестами на длительную работу.
