# Отчёт по файлу `services/q_core_agent/state/conv.py`

## Вход и цель
- [Факт] Модуль конвертации DTO ↔ protobuf для FSM состояний; цель — изоляция protobuf от бизнес-логики.

## Сбор контекста
- [Факт] Использует `google.protobuf`, UUID, `Timestamp`; маппит enum состояний и статусов переходов.
- [Гипотеза] Функции применяются в `fsm_handler` и `tick_orchestrator` для логирования и хранения.

## Локализация артефакта
- [Факт] Путь: `services/q_core_agent/state/conv.py`.

## Фактический разбор
- [Факт] Определяет исключение `ConversionError`.
- [Факт] Содержит вспомогательные функции `_create_uuid_proto`, `_extract_uuid_string`, `_timestamp_to_float`, `_float_to_timestamp`.
- [Факт] Реализует конвертеры `transition_dto_to_proto`, `transition_proto_to_dto`, `dto_to_proto`, `proto_to_dto`.
- [Факт] Предоставляет утилиты `dto_to_json_dict`, `dto_to_protobuf_json`, `create_proto_snapshot`, `parse_proto_snapshot`.

## Роль в системе и связи
- [Факт] Используется для сериализации состояния в protobuf и JSON-логах.
- [Гипотеза] Отделение модуля упрощает изменение protobuf без затрагивания core-логики.

## Несоответствия и риски
- [Гипотеза] Нет проверки типов при заполнении `context_data` и `state_metadata` (Med).
- [Гипотеза] Потеря `ts_mono` при конвертации в protobuf может вызвать несогласованность таймстампов (Low).

## Мини-патчи (safe-fix)
- [Патч] Валидация типов значений словарей перед записью в proto.
- [Патч] Логировать случаи генерации нового UUID при невалидном входном значении.

## Рефактор-скетч (по желанию)
```python
# [Патч] TypedDict для метаданных
class ContextData(TypedDict):
    key: str
```

## Примеры использования
- [Факт] `proto = dto_to_proto(snapshot)` — экспорт DTO в protobuf.
- [Факт] `dto = proto_to_dto(proto)` — импорт protobuf обратно.

## Тест-хуки/чек-лист
- [Факт] Юнит-тест: конвертация туда-обратно сохраняет `state` и `version`.
- [Факт] Проверка генерации нового UUID при передаче пустой строки.

## Вывод
- [Факт] Модуль обеспечивает полный цикл конверсий, но отсутствуют проверки типов и логирование аномалий.
- [Патч] Добавить валидацию словарей и дополнительное логирование.

## Стиль и маркировка
Использованы теги [Факт], [Гипотеза], [Патч] для обозначения уровня уверенности.
