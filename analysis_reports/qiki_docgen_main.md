# Анализ `tools/qiki_docgen/__main__.py`

## Вход и цель
- [Факт] Анализ CLI-модуля `tools/qiki_docgen/__main__.py`.
- [Факт] Итог: отчёт о командах, рисках и улучшениях.

## Сбор контекста
- [Факт] Импортирует `create_design_document`, `create_proto_contract`, `compile_protos`, `build_readme`.
- [Факт] Использует `argparse` и `logging` для CLI.
- [Гипотеза] Запускается из корня проекта для работы с путями.

## Локализация артефакта
- [Факт] Путь: `tools/qiki_docgen/__main__.py`.
- [Факт] Запуск: `python -m tools.qiki_docgen`.
- [Гипотеза] Окружение: Python ≥3.8 и установленный `protoc`.

## Фактический разбор
- [Факт] `main()` создаёт парсер с общими аргументами `--dry-run`, `--template`.
- [Факт] Подкоманды: `new`, `compile-protos`, `build-readme`.
- [Факт] `new` создаёт директорию компонента и генерирует файлы, затем компилирует протоколы.
- [Факт] `compile-protos` вызывает `compile_protos` без дополнительных параметров.
- [Факт] `build-readme` собирает главный README из документированных компонентов.
- [Гипотеза] При ошибке выход завершится кодом 1 через `sys.exit`.

## Роль в системе и связи
- [Факт] Точка входа утилиты документирования проекта.
- [Гипотеза] Используется разработчиками для автоматизации документации и протоколов.

## Несоответствия и риски
- [Гипотеза][Med] `template` не проверяется на допустимые значения.
- [Гипотеза][Low] Команда `new` может перезаписать существующие файлы без явного предупреждения при `--force`.
- [Гипотеза][Low] Отсутствует опция управления уровнем логирования.

## Мини-патчи (safe-fix)
- [Патч] Валидировать `args.template` перед использованием.
- [Патч] Проверять существование каталога и выдавать ошибку без `--force`.
- [Патч] Добавить аргумент `--verbose` для установки `DEBUG` уровня.

## Рефактор-скетч
```python
if args.command == "new" and os.path.exists(component_dir) and not args.force:
    parser.error("Component exists; use --force")
```

## Примеры использования
```bash
python -m tools.qiki_docgen new Q-Sim-Service
python -m tools.qiki_docgen compile-protos --dry-run
```

## Тест-хуки/чек-лист
- Юнит-тест парсинга аргументов каждой подкоманды.
- Мок тест для `new` с проверкой создания файлов и работы `--dry-run`.
- Тест обработки ошибок при отсутствии `protoc`.

## Вывод
- [Факт] CLI предоставляет базовый набор команд для генерации документации и протоколов.
- Первые улучшения: валидация параметров и защита от перезаписи; далее — расширение команд и уровней логирования.
