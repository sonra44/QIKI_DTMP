# Анализ: services/q_core_agent/tests/test_agent.py

## Вход и цель
- [Факт] Юнит-тесты для `QCoreAgent`, `BotCore`, `FSMHandler` и `TickOrchestrator`.
- [Цель] Зафиксировать покрытие и возможные улучшения тестов.

## Сбор контекста
- [Факт] Импорты используют модули ядра агента и protobuf-генерацию.
- [Факт] Реализованы фикстуры `mock_data_provider` и `monkeypatch`.
- [Гипотеза] Тесты ориентированы на минимально необходимое поведение без полноценных зависимостей.

## Локализация артефакта
- Путь: `services/q_core_agent/tests/test_agent.py`.
- Запуск: `PYTHONPATH=QIKI_DTMP pytest services/q_core_agent/tests/test_agent.py`.

## Фактический разбор
- [Факт] Проверяется инициализация `QCoreAgent` и изменение `tick_id`.
- [Факт] Проверяется обработка BIOS/FSM/Proposals с переходом в safe mode при ошибке.
- [Факт] `BotCore` генерирует детерминированный ID и сохраняет его на диске.
- [Факт] `FSMHandler` тестируется на нескольких переходах состояний.
- [Факт] `TickOrchestrator` проверяет последовательность вызовов и обработку исключений.
- [Гипотеза] Нет тестов на многопоточность и реальные сетевые сценарии.

## Роль в системе и связи
- [Факт] Гарантируют базовую работоспособность компонентов агента.
- [Гипотеза] Эти тесты используются как регрессии при изменении логики ядра.

## Несоответствия и риски
- [Med] Некоторые проверки выполняются через `Mock`, что может скрывать интеграционные проблемы.
- [Low] Отсутствуют negative-тесты для `BotCore` (невалидный путь, повреждённый ID).

## Мини-патчи (safe-fix)
- [Патч] Добавить тест на поведение `BotCore` при отсутствии файла конфигурации.
- [Патч] Расширить тесты `TickOrchestrator` проверкой логов или времени задержки.

## Рефактор-скетч
```python
# [Патч] пример доп. теста для BotCore
with tempfile.TemporaryDirectory() as tmpdir:
    bot = BotCore(base_path=tmpdir)
    os.remove(os.path.join(tmpdir, "config", "bot_config.json"))
    with pytest.raises(FileNotFoundError):
        bot.get_id()
```

## Примеры использования
- `pytest -k tick_orchestrator` — запуск только тестов оркестратора.
- `pytest -vv` — подробный вывод для отладки.

## Тест-хуки/чек-лист
- Проверить генерацию ID и его сохранение.
- Проверить переходы FSM при разных комбинациях BIOS и предложений.
- Проверить обработку исключений в `TickOrchestrator`.

## Вывод
- [Факт] Тесты охватывают ключевые сценарии работы агента.
- [Патч] Дополнить тесты негативными случаями и валидировать поведение `BotCore`.
