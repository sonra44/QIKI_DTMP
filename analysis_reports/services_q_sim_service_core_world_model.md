# Анализ: services/q_sim_service/core/world_model.py

## Вход и цель
- [Факт] Модель мира для симулятора Q-Sim.
- [Цель] Разобрать логику обновления состояния и выявить риски.

## Сбор контекста
- [Факт] Импортируются `ActuatorCommand` и `Vector3` из protobuf, `logger` из ядра агента.
- [Гипотеза] Используется совместно с `QSimService` для обработки команд.

## Локализация артефакта
- Путь: `services/q_sim_service/core/world_model.py`.
- Запуск: вызывается из симулятора при обработке актуаторных команд и шага времени.

## Фактический разбор
- [Факт] В `__init__` инициализируются позиция, курс, заряд и скорость.
- [Факт] `update` поддерживает команды моторов: установка скорости и вращение.
- [Факт] `step` перемещает позицию на основе скорости/курса и разряжает батарею.
- [Факт] `get_state` возвращает словарь с текущим состоянием.
- [Гипотеза] Нет обработки столкновений или сложной кинематики.

## Роль в системе и связи
- [Факт] Служит единственным источником истины для симуляции.
- [Гипотеза] Может расширяться для поддержки дополнительных типов команд и сенсоров.

## Несоответствия и риски
- [Med] Отсутствует ограничение диапазона `heading` при модификации.
- [Low] Батарея разряжается линейно без учёта нагрузок.

## Мини-патчи (safe-fix)
- [Патч] Нормализовать `speed` и `heading` в допустимых границах.
- [Патч] Добавить проверку типа команды и логирование неизвестных типов.

## Рефактор-скетч
```python
if command.command_type not in {"set_velocity_percent", "rotate_degrees_per_sec"}:
    logger.warning("Unknown command %s", command.command_type)
```

## Примеры использования
```python
wm = WorldModel()
cmd = ActuatorCommand(actuator_id=Unit(value="motor_left"), command_type="set_velocity_percent", int_value=50)
wm.update(cmd)
wm.step(1.0)
print(wm.get_state())
```

## Тест-хуки/чек-лист
- Проверить движение при различных углах и скоростях.
- Проверить нормализацию `heading` после нескольких вращений.
- Проверить корректность разрядки батареи.

## Вывод
- [Факт] Модель реализует базовую кинематику и заряд батареи.
- [Патч] Добавить валидацию команд и нормализацию параметров для стабильности.
