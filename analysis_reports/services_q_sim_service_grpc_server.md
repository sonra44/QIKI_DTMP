# Анализ: services/q_sim_service/grpc_server.py

## Вход и цель
- [Факт] gRPC-сервер для симулятора Q-Sim.
- [Цель] Описать структуру сервиса и возможные улучшения.

## Сбор контекста
- [Факт] Использует `grpc`, `futures`, `signal`, `QSimService` и автогенерированные protobuf API.
- [Гипотеза] Сервер запускается отдельно и взаимодействует с агентом через gRPC.

## Локализация артефакта
- Путь: `services/q_sim_service/grpc_server.py`.
- Запуск: `python services/q_sim_service/grpc_server.py`.

## Фактический разбор
- [Факт] Класс `QSimGrpcServicer` реализует методы: `GetSensorData`, `SendActuatorCommand`, `HealthCheck`.
- [Факт] В `serve` создаётся `grpc.server`, регистрируется сервicer и обрабатываются сигналы SIGINT/SIGTERM.
- [Факт] При запуске как скрипт конфиг загружается из `config.yaml`, настраивается логирование.
- [Гипотеза] Нет TLS/аутентификации и контроля потоков.

## Роль в системе и связи
- [Факт] Предоставляет внешний интерфейс для симуляции.
- [Гипотеза] Используется агентом и внешними клиентами для тестирования алгоритмов.

## Несоответствия и риски
- [Med] Отсутствует обработка исключений при старте сервера и чтении конфигурации.
- [Med] В методах gRPC ошибки возвращаются через код INTERNAL, но не логируется контекст запроса.

## Мини-патчи (safe-fix)
- [Патч] Добавить проверку существования конфиг-файла до запуска сервера.
- [Патч] Настроить ограничение `max_workers` и таймауты для повышения стабильности.

## Рефактор-скетч
```python
try:
    server.start()
except Exception as e:
    logger.error("Failed to start server: %s", e)
    raise
```

## Примеры использования
- `python services/q_sim_service/grpc_server.py` — запуск сервера на порту из конфига.
- gRPC-клиент: `grpcurl -plaintext localhost:50051 qsim.QSimAPI/HealthCheck`.

## Тест-хуки/чек-лист
- Проверить успешный запуск и отклик `HealthCheck`.
- Проверить корректное завершение по SIGINT.
- Интеграционный тест: отправка команды и проверка изменения состояния в `WorldModel`.

## Вывод
- [Факт] Сервер реализует базовый gRPC API без расширенных функций безопасности.
- [Патч] Добавить обработку ошибок старта и улучшить метрики/логирование.
