# Отчёт по файлу `services/q_core_agent/core/tick_orchestrator.py`

 codex/analyze-files-and-create-md-reports-rngq70
## Вход и цель
- [Факт] Оркестровщик тактов агента; цель — координация фаз выполнения с интеграцией StateStore.

## Сбор контекста
- [Факт] Импортирует `logger`, `IDataProvider`, `FsmSnapshotDTO`, `initial_snapshot`, `dto_to_proto`; поддерживает опциональный `AsyncStateStore`.
- [Гипотеза] Классы `QCoreAgent` и `AsyncStateStore` предоставляются внешним модулем и должны быть совместимы по API.

## Локализация артефакта
- [Факт] Путь: `services/q_core_agent/core/tick_orchestrator.py`; вызывается агентом при каждом тике.

## Фактический разбор
- [Факт] Конструктор сохраняет `agent`, `config`, `state_store`, счётчик ошибок и флаг `use_state_store` (читается из `QIKI_USE_STATESTORE`).
- [Факт] Метод `run_tick_async` выполняет пять фаз: обновление контекста, BIOS, FSM через StateStore, оценка предложений, принятие решения; логирует длительность фаз и ошибки.
- [Факт] `_handle_fsm_with_state_store` инициализирует StateStore при необходимости, обрабатывает DTO через `fsm_handler`, обновляет контекст.
- [Факт] Метод `run_tick` реализует синхронный legacy-путь без StateStore.

## Роль в системе и связи
- [Факт] Центральная координация между агентом, StateStore и `FSMHandler`.
- [Гипотеза] Выбор режима зависит от переменной окружения и наличия `state_store`.

## Несоответствия и риски
- [Гипотеза] В асинхронном режиме отсутствуют таймауты при обращении к `state_store` (Med).
- [Гипотеза] Дублирование логики между `run_tick_async` и `run_tick` усложняет сопровождение (Low).

## Мини-патчи (safe-fix)
- [Патч] Добавить `asyncio.wait_for` вокруг вызовов `state_store`.
- [Патч] Вынести общие фазы в отдельный метод для уменьшения дублирования.

## Рефактор-скетч (по желанию)
```python
# [Патч] Общий метод фаз, вызываемый из sync/async обёрток
async def _run_phases(self, data_provider):
    ...
```

## Примеры использования
- [Факт] `await tick_orchestrator.run_tick_async(provider)` — основной путь при включённом StateStore.
- [Факт] `tick_orchestrator.run_tick(provider)` — fallback в legacy-режиме.

## Тест-хуки/чек-лист
- [Факт] Мокаем `state_store.get` и `fsm_handler.process_fsm_dto` для проверки логирования и обработки ошибок.
- [Факт] Интеграционный тест: запуск с `QIKI_USE_STATESTORE=true` и проверка изменения `fsm_state`.

## Вывод
- [Факт] Оркестратор обеспечивает переход к StateStore, но содержит дублирование и отсутствие таймаутов.
- [Патч] Стоит добавить защиту от зависаний и объединить общую логику.

## Стиль и маркировка
Использованы теги [Факт], [Гипотеза], [Патч] для обозначения уровня уверенности.
=======
## Задачи
- Координация выполнения одного цикла агента, включая обновление контекста, обработку BIOS, FSM, оценку предложений и принятие решений.
- Поддержка асинхронного режима с интеграцией `AsyncStateStore` и fallback на синхронный метод.
- Сбор и логирование метрик длительности фаз, количества ошибок и состояния FSM.
- Обработка исключений: переключение в безопасный режим и пауза восстановления.
main
