# Docker Compose Phase 1: Базовая среда для разработки
# Устанавливает NATS и окружение для разработки/тестирования
# Версия: 1.0, Дата: 2025-09-02 (воссоздание)

services:
  # NATS Message Broker - ядро для FastStream
  nats:
    build:
      context: .
      dockerfile: Dockerfile.nats
    container_name: qiki-nats-phase1
    ports:
      - "4222:4222"
      - "8222:8222"
    command:
      - "--jetstream"
      - "--http_port"
      - "8222"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - nats-data-phase1:/data
    networks:
      - qiki-network-phase1
    tty: true

  # Окружение для разработки
  qiki-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: qiki-dev-phase1
    volumes:
      - .:/workspace
      - pip-cache-phase1:/root/.cache/pip
    working_dir: /workspace
    networks:
      - qiki-network-phase1
    depends_on:
      nats:
        condition: service_healthy
      nats-js-init:
        condition: service_completed_successfully
      q-sim-service:
        condition: service_healthy
      q-sim-radar:
        condition: service_started
      faststream-bridge:
        condition: service_started
    tty: true
    stdin_open: true
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/workspace/src:/workspace:/workspace/generated
      - BIOS_URL=http://q-bios-service:8080
    command: python -m qiki.services.q_core_agent.main --grpc
    restart: on-failure

  q-sim-service:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: qiki-sim-phase1
    volumes:
      - .:/workspace
      - pip-cache-phase1:/root/.cache/pip
    working_dir: /workspace
    healthcheck:
      test: ["CMD", "python", "-c", "import grpc,sys; from generated.q_sim_api_pb2_grpc import QSimAPIServiceStub; from generated.q_sim_api_pb2 import HealthCheckRequest; ch=grpc.insecure_channel('localhost:50051'); stub=QSimAPIServiceStub(ch); stub.HealthCheck(HealthCheckRequest(), timeout=2.0)"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - qiki-network-phase1
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/workspace/src:/workspace:/workspace/generated
      - RADAR_ENABLED=1
      - RADAR_NATS_ENABLED=1
      - TELEMETRY_NATS_ENABLED=1
      - TELEMETRY_INTERVAL_SEC=1.0
      - NATS_URL=nats://nats:4222
    command: python -m qiki.services.q_sim_service.grpc_server
    tty: true
    stdin_open: true
    depends_on:
      nats:
        condition: service_healthy

  q-bios-service:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: qiki-bios-phase1
    volumes:
      - .:/workspace
      - pip-cache-phase1:/root/.cache/pip
    working_dir: /workspace
    networks:
      - qiki-network-phase1
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/workspace/src:/workspace:/workspace/generated
      - LOG_LEVEL=INFO
      - BIOS_LISTEN_HOST=0.0.0.0
      - BIOS_LISTEN_PORT=8080
      - BOT_CONFIG_PATH=/workspace/src/qiki/services/q_core_agent/config/bot_config.json
      - SIM_GRPC_HOST=q-sim-service
      - SIM_GRPC_PORT=50051
      - SIM_HEALTH_CHECK_TIMEOUT=2.0
      - NATS_URL=nats://nats:4222
      - NATS_EVENT_SUBJECT=qiki.events.v1.bios_status
      - BIOS_PUBLISH_ENABLED=1
      - BIOS_PUBLISH_INTERVAL_SEC=5.0
    command: python -m qiki.services.q_bios_service.main
    ports:
      - "127.0.0.1:8080:8080"
    depends_on:
      nats:
        condition: service_healthy
      nats-js-init:
        condition: service_completed_successfully
      q-sim-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/healthz', timeout=2)"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  # Отдельный сервис, который крутит симуляцию и публикует кадры радара в NATS
  q-sim-radar:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: qiki-sim-radar-phase1
    volumes:
      - .:/workspace
      - pip-cache-phase1:/root/.cache/pip
    working_dir: /workspace
    networks:
      - qiki-network-phase1
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/workspace/src:/workspace:/workspace/generated
      - RADAR_ENABLED=1
      - RADAR_NATS_ENABLED=1
      - NATS_URL=nats://nats:4222
    command: python -m qiki.services.q_sim_service.main
    depends_on:
      nats:
        condition: service_healthy
    restart: on-failure
  faststream-bridge:
    build:
      context: .
      dockerfile: src/qiki/services/faststream_bridge/Dockerfile
    container_name: qiki-faststream-bridge-phase1
    networks:
      - qiki-network-phase1
    depends_on:
      nats:
        condition: service_healthy
    restart: on-failure

  # Registrar service for event auditing
  registrar:
    build:
      context: .
      dockerfile: src/qiki/services/registrar/Dockerfile
    container_name: qiki-registrar-phase1
    networks:
      - qiki-network-phase1
    depends_on:
      nats:
        condition: service_healthy
    volumes:
      - registrar-data-phase1:/var/log/qiki
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/app/src
    restart: on-failure

  # Инициализация JetStream Stream для радарных топиков
  nats-js-init:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: qiki-nats-js-init
    networks:
      - qiki-network-phase1
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/workspace/src:/workspace:/workspace/generated
      - NATS_URL=nats://nats:4222
      - RADAR_STREAM=QIKI_RADAR_V1
      - RADAR_SUBJECTS=qiki.radar.v1.*
      - RADAR_DUPLICATE_WINDOW_SEC=120
      - RADAR_MAX_BYTES=10485760
      - RADAR_MAX_AGE_SEC=3600
      - RADAR_CONSUMER_ACK_WAIT_SEC=45
      - RADAR_CONSUMER_MAX_DELIVER=7
      - RADAR_CONSUMER_MAX_ACK_PENDING=512
      - RADAR_FRAMES_DURABLE=radar_frames_pull
      - RADAR_TRACKS_DURABLE=radar_tracks_pull
      - EVENTS_ENABLED=1
      - EVENTS_STREAM=QIKI_EVENTS_V1
      - EVENTS_SUBJECTS=qiki.events.v1.>
      - EVENTS_DUPLICATE_WINDOW_SEC=120
      - EVENTS_MAX_BYTES=10485760
      - EVENTS_MAX_AGE_SEC=3600
      - EVENTS_CONSUMER_ACK_WAIT_SEC=45
      - EVENTS_CONSUMER_MAX_DELIVER=7
      - EVENTS_CONSUMER_MAX_ACK_PENDING=512
      - EVENTS_AUDIT_SUBJECT=qiki.events.v1.audit
      - EVENTS_AUDIT_DURABLE=events_audit_pull
    command: python tools/js_init.py
    restart: "no"

  loki:
    image: grafana/loki:2.9.0
    container_name: qiki-loki-phase1
    ports:
      - "3100:3100"
    volumes:
      - ./config/loki-config.yaml:/etc/loki/config.yaml
      - loki-data-phase1:/loki
    command: -config.file=/etc/loki/config.yaml
    networks:
      - qiki-network-phase1
    restart: unless-stopped

  promtail:
    image: grafana/promtail:latest
    container_name: qiki-promtail-phase1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config/promtail-config.yaml:/etc/promtail/config.yaml
    environment:
      - DOCKER_API_VERSION=1.44
    command: -config.file=/etc/promtail/config.yaml
    networks:
      - qiki-network-phase1
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.4.2
    container_name: qiki-grafana-phase1
    ports:
      - "3000:3000"
    volumes:
      - ./config/grafana.ini:/etc/grafana/grafana.ini
      - ./config/grafana-datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml
      - grafana-data-phase1:/var/lib/grafana
    networks:
      - qiki-network-phase1
    depends_on:
      - loki
    restart: unless-stopped

networks:
  qiki-network-phase1:
    driver: bridge

volumes:
  nats-data-phase1:
  pip-cache-phase1:
  registrar-data-phase1:
  loki-data-phase1: {}
  grafana-data-phase1: {}
