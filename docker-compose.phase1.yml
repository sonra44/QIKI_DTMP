# Docker Compose Phase 1: Базовая среда для разработки
# Устанавливает NATS и окружение для разработки/тестирования
# Версия: 1.0, Дата: 2025-09-02 (воссоздание)

version: '3.8'

services:
  # NATS Message Broker - ядро для FastStream
  nats:
    build:
      context: .
      dockerfile: Dockerfile.nats
    container_name: qiki-nats-phase1
    ports:
      - "4222:4222"    # Клиентский порт NATS
      - "8222:8222"    # Порт для HTTP мониторинга
    command:
      - "--jetstream"
      - "--http_port"
      - "8222"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - nats-data-phase1:/data
    networks:
      - qiki-network-phase1
    tty: true

  # Окружение для разработки
  qiki-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: qiki-dev-phase1
    volumes:
      - .:/workspace
      - pip-cache-phase1:/root/.cache/pip
    working_dir: /workspace
    networks:
      - qiki-network-phase1
    depends_on:
      nats:
        condition: service_healthy
      q-sim-service:
        condition: service_healthy
    tty: true
    stdin_open: true
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/workspace
    command: python services/q_core_agent/main.py --grpc
    restart: on-failure

  q-sim-service:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: qiki-sim-phase1
    healthcheck:
      test: ["CMD", "python", "-c", "import grpc,sys; from generated.q_sim_api_pb2_grpc import QSimAPIStub; from google.protobuf.empty_pb2 import Empty; ch=grpc.insecure_channel('localhost:50051'); stub=QSimAPIStub(ch); stub.HealthCheck(Empty(), timeout=2.0)"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - qiki-network-phase1
    environment:
      - PYTHONDONTWRITEBYTECODE=1
    command: python services/q_sim_service/grpc_server.py
    tty: true
    stdin_open: true
    depends_on:
      nats:
        condition: service_healthy

  faststream-bridge:
    build:
      context: .
      dockerfile: services/faststream_bridge/Dockerfile
    container_name: qiki-faststream-bridge-phase1
    networks:
      - qiki-network-phase1
    depends_on:
      nats:
        condition: service_healthy
    restart: on-failure

networks:
  qiki-network-phase1:
    driver: bridge

volumes:
  nats-data-phase1:
  pip-cache-phase1:
