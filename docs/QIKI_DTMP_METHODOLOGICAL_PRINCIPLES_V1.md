# QIKI_DTMP — Общие методические принципы и руководство для агента (v1.1)

> Назначение: единая инструкция для ИИ‑агентов/исполнителей (Warp Agent и др.) о том, **как** работать в проекте QIKI_DTMP: планирование, код, тесты, документация, инфраструктура, безопасность, выпуск релизов.

---

## 0. Область действия и цели
- Область: все репозитории/микросервисы QIKI_DTMP (симулятор, Q‑Core, радарный конвейер, операторская консоль и др.).
- Цели: скорость без потери качества, воспроизводимость, наблюдаемость, отказоустойчивость, совместимость, прозрачность процессов.
- Языки: RU/EN. **Правило зеркала** — при нетривиальных изменениях обновлять оба языка.

---

## 1. Термины (минимум)
- **Задача**: единица планирования (issue). Имеет ID, приоритет, статус, оценку, связи.
- **DoR/DoD**: Definition of Ready / Done (см. §10).
- **ADR**: Architectural Decision Record (см. §7).

---

## 2. Система планирования
### 2.1 Приоритеты и ID
- Приоритеты: **P1** (критический), **P2** (высокий), **P3** (средний), **P4** (низкий).
- Формат ID: `P<prio>-NNN` (напр., `P1-001`). Допустимо глобальное сквозное `TSK-XXXX` для межприоритетных связей.

### 2.2 Статусы (нормализовано)
- **PLANNED** → **TODO** → **IN_PROGRESS** → **REVIEW** → **QA** → **COMPLETED** → **RELEASED**.
- Побочные: **BLOCKED** (указать причину/зависимость), **ON_HOLD**.

### 2.3 Правила обновления
- Старт: перевод в **IN_PROGRESS**, указать дату/исполнителя/ветку.
- Завершение разработки: PR → **REVIEW**, чек‑лист PR (§12).
- После тестирования: **QA**. Указать покрытие и результаты.
- Слияние в main: **COMPLETED** с кратким отчётом (что, почему, риски).
- Попадание в релиз: **RELEASED** с номером версии и ссылкой на релиз‑ноутс.
- Еженедельный обзор: пересмотр приоритетов/сроков, актуализация зависимостей в `TASK_DETAILS.md`.

### 2.4 Дорожные карты и зависимости
- Поддерживать `IMPLEMENTATION_ROADMAP.md`, `STEP_A_ROADMAP.md`; связи и риски — в `TASK_DETAILS.md` (напр., `P3-001` зависит от `P3-002`).

---

## 3. Git‑поток, коммиты и релизы
- Ветвление: `main` (защищённая), `develop` (опционально), фичи `feature/<id>-<slug>`, багфиксы `fix/<id>`, релизы `release/x.y.z`, хотфиксы `hotfix/x.y.z`.
- Коммиты: **Conventional Commits** (`feat:`, `fix:`, `docs:`, `refactor:`, `test:`, `build:`, `chore:`) + ID задачи.
- Релизы: **SemVer** (MAJOR.MINOR.PATCH). Теги и релиз‑ноутсы обязательны. Миграции и совместимость фиксируются отдельно.
- CODEOWNERS для критичных путей; обязательные ревью.

---

## 4. Качество кода и статанализ
- Стиль: PEP 8 + типизация `mypy` (строгий режим по мере готовности).
- Линтеры: **Ruff** (стиль/ошибки) и **Pylint** (цель ≥ 8/10). Локально и в CI — обязательно.
- Доп. проверки: `bandit` (безопасность), `detect-secrets`/`trufflehog` (секреты), `pip-audit`/`osv-scanner` (уязвимости).
- Docstring для всех публичных функций/классов (Google/Numpy style), автоген Sphinx/Markdown — по репо.

---

## 5. Тестирование (пирамидой)
- **Unit** (основа), **интеграционные**, **e2e** (минимально‑критичные сценарии).
- Инструменты: `pytest`, `pytest-textual` (для TUI), `pytest-asyncio`.
- Покрытие: ≥ **80%** по строкам/ветвлениям на модульном уровне (не «подкрашивать» ненужным). Отчёты в CI.
- Дополнительно: property‑based (Hypothesis) для протоколов/парсеров; фазы отказов/времени; регрессионные снапшоты для TUI.
- Нагрузка/профилирование: `pytest-benchmark`/`py-spy`/`scalene` на горячих путях.
- Chaos‑тесты (локально/интеграция): сетевые флаппинги, задержки, разрывы NATS/gRPC.

---

## 6. Документация
- Обновлять `README.md`, `TASK_LIST.md`, `TASK_DETAILS.md`, `RADAR.md` и др. при изменениях API/архитектуры.
- **DOCUMENTATION_UPDATE_PROTOCOL.md** обязателен к исполнению: ссылки, метрики, changelog, RU/EN синхронизация.
- **ADR**: все архитектурные решения — в `/docs/adrs/ADR-xxxx.md` (контекст → решения → последствия).
- Диаграммы‑как‑код (Mermaid/PlantUML). Примеры использования и сценарии запуска (dev/prod).

---

## 7. Асинхронность и конкурентность
- Везде `asyncio`; не блокировать event loop. I/O только `await`/асинхронные клиенты.
- Ограничивать параллелизм (semaphores, bounded queues). Тайм‑ауты и отмены (cancellation) обязательны.
- Контекст трассировки/логирования прокидывать через таски.

---

## 8. Сообщения и шины: NATS JetStream
- Подключение: `allow_reconnect`, `reconnect_time_wait`, `max_reconnect_attempts`; коллбеки `disconnected_cb`, `reconnected_cb`, `error_cb`.
- Соглашения по темам: `qiki.<service>.<domain>.<event>`; версии схем в теме или в заголовках.
- Схемы сообщений: Protobuf/JSON‑Schema; **контракты неизменности** (эволюция через новые поля с обратной совместимостью).
- Доставка: «по факту» **at‑least‑once**; обеспечить идемпотентность обработчиков (идемпотентные ключи, дедупликация).
- Очереди/потоки: ретеншн, DLQ/parking lot для ядовитых сообщений, метрики перезакачек.
- Трассировка: заголовки с `trace_id`/`span_id`; OpenTelemetry exporter.

---

## 9. gRPC (симулятор, ядро)
- Дедлайны/тайм‑ауты обязательны. Ретраи с экспоненциальной задержкой и джиттером; ограничение попыток.
- Идемпотентность для повторяемых операций (server‑side tokens/sequence ids).
- Совместимость: **версионирование proto** (package vN, поля не переиспользовать), обратная совместимость минимум на 2 минорные версии.
- health/check, channel state метрики, backoff‑политики; пулы каналов.

---

## 10. DoR / DoD
- **Definition of Ready**: цель/результат, критерии приёмки, зависимости, оценка, план тестов, миграции/фичефлаги, риски.
- **Definition of Done**: код + тесты (зелёные) + линтеры (пороги выполнены) + доки обновлены + миграции применимы + метрики/логи добавлены + релиз‑ноутс (если затрагивает пользовательский контракт).

---

## 11. Телеметрия и наблюдаемость
- **OpenTelemetry**: трейсинг + метрики + логи. Контекст в сообщениях.
- Метрики: latency, error rate, throughput; NATS/gRPC (подключение, ретраи, лаг), TUI FPS/latency.
- **SLO/ошибочный бюджет**: задать целевые латентности и доступность ядровых путей; алерты по промахам.
- Дашборды: Grafana (TUI, NATS, gRPC, Event Store). Логи в Loki/ELK. Семплинг трасс.

---

## 12. CI/CD (GitHub Actions)
- Джобы: `lint` (Ruff, Pylint, mypy) → `test` (pytest + coverage) → `security` (bandit, osv) → `build` (Docker) → `scan` (Trivy/Grype, SBOM) → `publish` (registry) → `deploy` (опционально) → `e2e` (по окружению).
- Артефакты: отчёты покрытия, pytest‑junit, SBOM (CycloneDX), контейнеры с метками `git_sha`, `version`.
- Политики: запрет мержа без зелёного CI и 1–2 аппрувов CODEOWNERS.

---

## 13. Docker и инфраструктура
- Команды: `docker compose up -d --build`, `docker compose down`, `docker compose ps`, `docker compose logs -f <service>`.
- Окружения: `docker-compose.dev.yml` vs `docker-compose.prod.yml`; healthchecks, лог‑драйверы, resource limits.
- Конфигурация: только **через переменные** (`.env`/Secrets). Примеры: `NATS_URL`, `QSIM_GRPC_HOST`, `AGENT_GRPC_HOST` и др.
- Безопасность образов: non‑root, минимальные базовые образы, кэш‑слои, pin версий, Trivy/Grype, политика обновлений.
- Протоколы обновлений: правки Dockerfile/compose → обновить `README.md`, `GRPC_MIGRATION_PLAN.md` и релиз‑ноутс.

---

## 14. Данные, миграции, резервирование
- Event Store/хранилища: схемы/контракты, миграции с обратной совместимостью и скриптами отката.
- Политики ретенции/бэкапов и проверка восстановления.
- Маскирование PII в логах/дампах; шифрование секретов.

---

## 15. Безопасность и комплаенс
- Минимально необходимые права, секреты только в Secret‑менеджерах (GitHub Secrets, dotenv‑vault и т.п.).
- Регулярные обновления зависимостей (Dependabot/Renovate).
- Политики ревью, CODEOWNERS, запрет `force‑push` в `main`.
- Supply‑chain: подпись образов/артефактов, верификация источника, контроль третьих зависимостей.

---

## 16. Консоль оператора (TUI)
- Панели: телеметрия, радар, чат, команды, метрики, настройки. Библиотеки: Rich/Textual; `Live` без мерцания.
- Тёмная/светлая темы, адаптация к размеру терминала, индикаторы долгих операций.
- Командная палитра и горячие клавиши (конфигурируемые). Двусторонний чат с Q‑агентом. Подтверждения опасных команд.
- Метрики: CPU, RAM, NATS/gRPC задержки; настройки адресов/частоты/тем.
- Ошибки/связь: уведомления, автопереподключение (экспоненциальный бэкофф), запись событий.
- Дополнительно: a11y (контраст/скринридер‑френдли), i18n RU/EN, режим деградации/оффлайн.

---

## 17. Типовые задачи и шаблоны промтов
- **Bug fix**: воспроизвести через тесты, минимальная правка, Ruff/Pylint ≥ порог, покрытие ≥ 80%, changelog + осмысленный коммит.
- **Feature**: уточнить API, план (интерфейсы → логика → тесты → доки), не ломать публичный контракт, обновить документацию.
- **Refactor**: выявить сложность/дубли/типы, итерации с тестами, без изменения внешнего API без согласования, фиксировать причины.
- **Docs**: сверка факта и текста, RU/EN зеркала, форматирование Markdown, без изменения кода.
- **DevOps**: оптимизация Dockerfile, healthchecks, метрики, логирование, GH Actions, скан‑политики.
- **Tests**: ветвления/границы, mocks, интеграция с NATS/gRPC (тестовые серверы/фейки), property‑based для протоколов.
- **Spike/Research** (добавлено): ограничение по времени, критерии «успех/отказ», выводы → ADR/issue‑комментарий.

---

## 18. Инциденты, откаты, релизы
- Релизы: канареечные/blue‑green (где применимо), фичефлаги/kill‑switch.
- Инциденты: этапы — обнаружение → триаж (P1..P4) → сдерживание → устранение → постмортем. Хранить постмортемы.
- Откаты: чёткие скрипты/плейбуки; миграции двунаправленные. Авто‑алерты при деградации SLO.

---

## 19. Чек‑листы (сжатые)
**PR Checklist**
- [ ] Связанная задача/ID в заголовке PR; Conventional Commits.
- [ ] Тесты добавлены/обновлены; локально зелёные.
- [ ] Ruff/Pylint/mypy зелёные; покрытие ≥ 80%.
- [ ] Документация/ADR обновлены; RU/EN при необходимости.
- [ ] Миграции/фичефлаги/метрики/логи учтены.
- [ ] Без секретов; изменения конфигов — описаны.

**Release Checklist**
- [ ] Версия по SemVer; теги созданы.
- [ ] Релиз‑ноутс с изменениями/миграциями/рисками.
- [ ] Образы собраны, просканированы, подписаны, опубликованы.
- [ ] Дашборды/алерты обновлены при изменении метрик.
- [ ] План отката и проверка восстановления.

**Task Ready (DoR)**
- [ ] Цель/результат, критерии приёмки, оценка.
- [ ] Зависимости/риски, план тестов.
- [ ] План миграций/фичефлагов (если нужно).

**Task Done (DoD)**
- [ ] Код/тесты/линтеры — зелёные.
- [ ] Документация и ADR — обновлены.
- [ ] Метрики/логи/алерты — на месте.
- [ ] Статус/отчёт/связи — обновлены в трекере.

---

## 20. Мини‑реестр переменных окружения (пример)
- `NATS_URL`, `NATS_USER`, `NATS_PASS`
- `QSIM_GRPC_HOST`, `QSIM_GRPC_PORT`
- `AGENT_GRPC_HOST`, `AGENT_GRPC_PORT`
- `OTEL_EXPORTER_OTLP_ENDPOINT`, `OTEL_RESOURCE_ATTRIBUTES`
- `LOG_LEVEL`, `APP_ENV` (dev|prod)

---

## 21. Итоги и применение
- Агент **сначала** анализирует контекст (этот файл + ROADMAP + TASK_LIST/TASK_DETAILS), **затем** формирует план (DoR), исполняет итеративно, валидирует (линтеры/тесты), фиксирует результаты (DoD), выпускает/документирует.
- Любой нестандартный шаг (удаления, изменение публичных API, несовместимые миграции) — только с явным обоснованием/согласованием и ADR.

> Версия документа: v1.1. Предложения по улучшению оформлять PR‑ом с меткой `docs:guidelines` и коротким ADR при существенных изменениях.