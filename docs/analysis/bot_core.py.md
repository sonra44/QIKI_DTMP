# Анализ файла: `services/q_core_agent/core/bot_core.py`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл определяет класс `BotCore`, который является **фундаментальным, низкоуровневым представлением сущности бота** в системе. Его основная задача — инкапсулировать все, что касается идентификации бота, его статической аппаратной конфигурации и прямого взаимодействия с "сырыми" данными сенсоров и актуаторов.

**Архитектурная роль:** `BotCore` выступает как **абстракция аппаратного уровня**. Он скрывает детали физического оборудования или его симуляции от высокоуровневой логики агента. Это позволяет агенту работать с абстрактными понятиями "сенсорные данные" и "команды актуатора", не зная, как именно они генерируются или исполняются. Это также является частью **эволюционного дизайна** проекта, где `BotCore` представляет собой базовую концепцию, которая затем развивается в `ShipCore` для космических операций.

---

## 2. Детальный Разбор Функциональности

### 2.1. Идентификация Бота

-   **`_initialize_bot_id()` / `_generate_bot_id()`**: При инициализации `BotCore` пытается загрузить уникальный ID бота из файла `.qiki_bot.id` (расположенного в корне директории `q_core_agent`). Если файл не найден, генерируется новый ID на основе временной метки, имени хоста и случайного компонента. Этот ID затем сохраняется для обеспечения персистентности.
-   **`get_id()`**: Публичный метод для получения уникального ID бота.
-   **Зачем это нужно:** Уникальный ID критически важен для трассировки, логирования и идентификации конкретного экземпляра бота в распределенной системе или при работе с несколькими ботами.

### 2.2. Управление Конфигурацией

-   **`_load_config()`**: Загружает статическую конфигурацию бота из файла `bot_config.json` (расположенного в поддиректории `config/` внутри `q_core_agent`).
-   **`get_property(property_name)`**: Предоставляет доступ к свойствам, определенным в конфигурации (например, `bot_type`, `hardware_profile`).
-   **Зачем это нужно:** Отделение конфигурации от кода делает бота гибким. Можно изменить его аппаратный профиль или тип, не меняя исходный код.

### 2.3. Взаимодействие с Сенсорами

-   **`register_sensor_callback(callback)`**: Позволяет другим модулям регистрировать функции обратного вызова, которые будут вызываться при поступлении новых "сырых" сенсорных данных.
-   **`_process_incoming_sensor_data(sensor_data)`**: Внутренний метод, который обновляет снимок текущих сенсорных данных и вызывает все зарегистрированные колбэки.
-   **`get_latest_sensor_value(sensor_id)` / `current_sensor_snapshot`**: Предоставляют доступ к последним полученным данным от конкретного сенсора или ко всему снимку сенсоров.
-   **Зачем это нужно:** `BotCore` выступает как точка сбора всех "сырых" данных от сенсоров, прежде чем они будут обработаны высокоуровневой логикой.

### 2.4. Взаимодействие с Актуаторами

-   **`send_actuator_command(command)`**: Отправляет "сырую" команду исполнительному механизму. Перед отправкой команды выполняется **валидация `actuator_id`** на соответствие списку актуаторов, определенных в `hardware_profile` из `bot_config.json`.
-   **Зачем это нужно:** `BotCore` является точкой отправки всех команд на "железо" или в симулятор. Валидация предотвращает отправку команд несуществующим актуаторам.

### 2.5. Режим "Minimal"

-   **Как работает:** Если в `bot_config.json` установлен `"mode": "minimal"`, то методы взаимодействия с сенсорами и актуаторами становятся неработоспособными. Команды актуаторам игнорируются, а запросы сенсорных данных возвращают `None` или пустые списки.
-   **Зачем это нужно:** Позволяет запускать `BotCore` в очень легковесном режиме, например, для тестирования только логики идентификации или конфигурации, без необходимости симулировать аппаратное взаимодействие.

---

## 3. Взаимодействие с Другими Модулями

-   **`agent.py`**: `QCoreAgent` создает экземпляр `BotCore` и использует его для отправки команд актуаторам (`send_actuator_command`).
-   **`bios_handler.py`**: Использует `bot_core.get_property("hardware_profile")` для получения списка ожидаемых устройств при диагностике BIOS.
-   **`generated/sensor_raw_in_pb2.py` / `generated/actuator_raw_out_pb2.py`**: `BotCore` оперирует Protobuf-сообщениями для представления "сырых" сенсорных данных и команд актуаторам.
-   **`bot_config.json`**: Является источником статической конфигурации для `BotCore`.
