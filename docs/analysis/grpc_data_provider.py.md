# Анализ файла: `services/q_core_agent/core/grpc_data_provider.py`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл определяет класс `GrpcDataProvider`, который является **конкретной реализацией `IDataProvider`** для сетевого взаимодействия. Его основная задача — позволить `Q-Core Agent` обмениваться данными с `Q-Sim Service` по сети, используя протокол **gRPC**.

**Архитектурная роль:** `GrpcDataProvider` является ключевым компонентом для построения **распределенной микросервисной архитектуры**. Он абстрагирует сложности сетевого взаимодействия, позволяя агенту и симулятору работать как независимые процессы, потенциально на разных машинах или в разных контейнерах. Это обеспечивает масштабируемость и гибкость развертывания.

---

## 2. Детальный Разбор Функциональности

### 2.1. Управление gRPC Соединением

-   **`__init__(self, grpc_server_address)`**: При инициализации устанавливает gRPC-канал (`grpc.insecure_channel`) к указанному адресу сервера (`localhost:50051` по умолчанию) и создает `QSimAPIStub` — клиент для gRPC-сервиса.
-   **`_connect()`**: Выполняет фактическое подключение и включает `HealthCheck` вызов к серверу для проверки его доступности. Любые ошибки подключения перехватываются (`grpc.RpcError`) и логируются, что является важным элементом отказоустойчивости.
-   **`__del__()`**: Обеспечивает корректное закрытие gRPC-канала при уничтожении объекта.

### 2.2. Реализация Методов `IDataProvider`

-   **`get_sensor_data()`**: Выполняет реальный gRPC-вызов `self.stub.GetSensorData()`. Это основной способ получения актуальных данных сенсоров от симулятора.
-   **`send_actuator_command(command)`**: Выполняет реальный gRPC-вызов `self.stub.SendActuatorCommand()`, отправляя команды исполнительным механизмам симулятора.

### 2.3. Заглушки (Mocks) для Неуправляемых Данных

Критически важно понимать, что следующие методы **НЕ делают gRPC-вызовов** и возвращают либо заглушки, либо пустые данные:

-   **`get_bios_status()`**: Возвращает реалистичную, но **локально сгенерированную** `BiosStatusReport`. `Q-Sim Service` не управляет статусом BIOS.
-   **`get_fsm_state()`**: Возвращает **пустой** `FsmStateSnapshot` (или минимальный stub, если `QIKI_USE_STATESTORE` включен). `Q-Sim Service` не управляет состоянием FSM.
-   **`get_proposals()`**: Всегда возвращает **пустой список**. `Q-Sim Service` не генерирует предложения.

-   **Почему это важно:** Это указывает на **архитектурный пробел** в текущей реализации `Q-Sim Service`. Для полноценной gRPC-ориентированной системы, `Q-Sim Service` должен был бы предоставлять эти данные через gRPC-методы, а не `GrpcDataProvider` генерировать их локально. Это ключевой момент, который необходимо учитывать при дальнейшем развитии проекта (как описано в `GRPC_MIGRATION_PLAN.md`).

---

## 3. Отказоустойчивость

-   **Как реализовано:** Все gRPC-вызовы обернуты в блоки `try...except grpc.RpcError`.
-   **Почему это важно:** В случае проблем с сетью, недоступности сервера или других ошибок gRPC, `GrpcDataProvider` не падает, а логирует ошибку и возвращает безопасные значения по умолчанию (например, пустое показание сенсора или `None`). Это позволяет `Q-Core Agent` продолжать работу, возможно, в деградированном режиме.

---

## 4. Взаимодействие с Другими Модулями

-   **`main.py`**: Создает экземпляр `GrpcDataProvider` при запуске агента с флагом `--grpc`.
-   **`interfaces.py`**: `GrpcDataProvider` реализует интерфейс `IDataProvider`.
-   **`generated/q_sim_api_pb2_grpc.py`**: Использует сгенерированный `QSimAPIStub` для выполнения удаленных вызовов.
-   **`generated/*_pb2.py`**: Работает с различными Protobuf-сообщениями (`SensorReading`, `ActuatorCommand`, `BiosStatusReport`, `FsmStateSnapshot`, `Proposal`).
