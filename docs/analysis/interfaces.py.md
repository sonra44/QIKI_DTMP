# Анализ файла: `services/q_core_agent/core/interfaces.py`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл является **фундаментом модульности и гибкости** `Q-Core Agent`. Он определяет **абстрактные интерфейсы (контракты)**, которым должны соответствовать различные компоненты системы. Вместо того чтобы высокоуровневые модули зависели от конкретных реализаций, они зависят от этих абстракций.

**Архитектурная роль:** Реализация **Принципа Инверсии Зависимостей (Dependency Inversion Principle - DIP)**. Это означает, что:
-   Высокоуровневые модули (например, `QCoreAgent`) не зависят от низкоуровневых модулей (например, `GrpcDataProvider`).
-   Оба типа модулей зависят от **абстракций** (интерфейсов).

Это делает систему чрезвычайно **гибкой, расширяемой и тестируемой**.

---

## 2. Детальный Разбор Интерфейсов

### 2.1. `IDataProvider`

-   **Назначение:** Определяет контракт для любого компонента, который поставляет данные `Q-Core Agent` и принимает от него команды.
-   **Методы:**
    -   `get_bios_status() -> BiosStatusReport`: Получает отчет о состоянии BIOS.
    -   `get_fsm_state() -> FsmStateSnapshot`: Получает текущее состояние конечного автомата.
    -   `get_proposals() -> List[Proposal]`: Получает список предложений от "разума" бота.
    -   `get_sensor_data() -> SensorReading`: Получает последние данные от сенсоров.
    -   `send_actuator_command(command: ActuatorCommand)`: Отправляет команду исполнительному механизму.
-   **Значимость:** Это основной канал взаимодействия агента с внешним миром (симулятором или реальным оборудованием).

### 2.2. Другие Интерфейсы

-   **`IBiosHandler`**: Контракт для обработки отчетов BIOS.
-   **`IFSMHandler`**: Контракт для управления переходами состояний FSM.
-   **`IProposalEvaluator`**: Контракт для оценки и выбора лучших предложений.
-   **`IRuleEngine`**: Контракт для движка, генерирующего предложения на основе правил.
-   **`INeuralEngine`**: Контракт для движка, генерирующего предложения на основе моделей машинного обучения.

---

## 3. Детальный Разбор Реализаций Интерфейсов

Файл также содержит две конкретные реализации `IDataProvider`, демонстрирующие гибкость архитектуры.

### 3.1. `MockDataProvider`

-   **Назначение:** Используется для **тестирования и разработки**. Он предоставляет заранее определенные, "поддельные" данные для всех методов `IDataProvider`.
-   **Особенности:** Метод `get_fsm_state()` имеет специальную логику: если переменная окружения `QIKI_USE_STATESTORE` установлена в `true`, он возвращает минимальный "заглушечный" Protobuf-объект. Это позволяет `FSMHandler` получать состояние из `StateStore`, а не из `MockDataProvider`.
-   **Значимость:** Позволяет тестировать `QCoreAgent` в полной изоляции, без необходимости запускать симулятор или иметь сетевое соединение.

### 3.2. `QSimDataProvider`

-   **Назначение:** Используется для **прямого взаимодействия** с экземпляром `QSimService` (симулятора) в том же процессе. Это режим "Legacy" или "MVP" (Minimum Viable Product).
-   **Особенности:** Методы `get_sensor_data()` и `send_actuator_command()` напрямую вызывают соответствующие методы экземпляра `QSimService`. Методы `get_bios_status()`, `get_fsm_state()` и `get_proposals()` генерируют или возвращают начальные/пустые данные, так как `QSimService` не управляет этими аспектами.
-   **Значимость:** Позволяет быстро запустить и отладить систему без сложной сетевой настройки.

---

## 4. Взаимодействие с Другими Модулями

-   **`agent.py`**: `QCoreAgent` зависит от этих интерфейсов и содержит экземпляры их конкретных реализаций.
-   **`main.py`**: Отвечает за выбор и создание нужной реализации `IDataProvider` на основе аргументов командной строки (`--mock`, `--grpc`) или режима по умолчанию.
-   **`grpc_data_provider.py`**: Является еще одной, сетевой реализацией `IDataProvider`.
-   **`generated/*_pb2.py`**: Интерфейсы определяют методы, которые возвращают или принимают Protobuf-сообщения, сгенерированные из `.proto` файлов.
