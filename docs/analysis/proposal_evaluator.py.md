# Анализ файла: `services/q_core_agent/core/proposal_evaluator.py`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл определяет класс `ProposalEvaluator`, который является реализацией `IProposalEvaluator`. Его основная задача — принимать список «предложений» (Proposals), сгенерированных различными движками (`RuleEngine`, `NeuralEngine`), фильтровать их и выбирать наиболее подходящие на основе заданных критериев.

**Архитектурная роль:** `ProposalEvaluator` выступает в роли **арбитра или фильтра решений**. Он является критически важным звеном в процессе принятия решений агентом, так как именно здесь определяется, какое из множества потенциальных действий будет выбрано для исполнения. Это позволяет системе иметь несколько источников предложений, но при этом сохранять единый, контролируемый процесс выбора.

---

## 2. Детальный Разбор Логики

Основная логика сосредоточена в методе `evaluate_proposals(proposals)`.

### 2.1. Фильтрация по Уверенности (Confidence)

-   **Как работает:** Первым шагом `ProposalEvaluator` отфильтровывает все предложения, чья `confidence` (уверенность) ниже заданного порога `self.confidence_threshold`. Этот порог является конфигурируемым параметром (`proposal_confidence_threshold` в `config.yaml`).
-   **Зачем это нужно:** Это позволяет отсеять "слабые" или ненадежные предложения, которые могут быть результатом неточных сенсорных данных или низкой уверенности ML-модели.

### 2.2. Сортировка и Выбор Лучшего Предложения

После фильтрации оставшиеся предложения сортируются по следующим критериям (в порядке убывания приоритета):

1.  **По типу предложения (`Proposal.type`, по возрастанию):**
    -   **Как работает:** Предложения сортируются по значению `enum` `ProposalType`. Важно отметить, что **меньшее числовое значение `enum` соответствует более высокому логическому приоритету** (например, `SAFETY=1` имеет более высокий приоритет, чем `PLANNING=2`).
    -   **Зачем это нужно:** Это гарантирует, что предложения, связанные с безопасностью, всегда будут рассматриваться в первую очередь, даже если их `priority` или `confidence` ниже, чем у других типов предложений.

2.  **По приоритету (`priority`, по убыванию):**
    -   **Как работает:** Внутри одного типа предложения, они сортируются по полю `priority` (от 0.0 до 1.0), где более высокое значение означает более высокий приоритет.

3.  **По уверенности (`confidence`, по убыванию):**
    -   **Как работает:** Если тип и приоритет предложений совпадают, выбирается то, у которого выше `confidence`.

-   **Выбор (MVP):** На текущий момент (MVP) `ProposalEvaluator` выбирает **только одно, наилучшее** предложение после сортировки. В будущих версиях может быть реализована логика выбора нескольких предложений или более сложная арбитражная система.

---

## 3. Взаимодействие с Другими Модулями

-   **`agent.py`**: `QCoreAgent` вызывает `proposal_evaluator.evaluate_proposals()` после сбора всех предложений от `RuleEngine` и `NeuralEngine`.
-   **`interfaces.py`**: `ProposalEvaluator` реализует интерфейс `IProposalEvaluator`.
-   **`generated/proposal_pb2.py`**: Работает с объектами `Proposal`, используя их поля для фильтрации и сортировки.
-   **`config.yaml`**: Получает значение `confidence_threshold` из конфигурационного файла агента.
