# Анализ файла: `protos/actuator_raw_out.proto`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл определяет **универсальный формат сообщений для "сырых" команд исполнительным механизмам** (`ActuatorCommand`). Он спроектирован так, чтобы быть достаточно гибким для управления различными типами актуаторов (двигатели, сервоприводы и т.д.) в стандартизированном и надежном виде.

**Архитектурная роль:** `actuator_raw_out.proto` обеспечивает **стандартизированный интерфейс управления**. Наличие единой схемы для всех исходящих команд упрощает логику управления в `Q-Core Agent`. Использование `oneof` для основного поля значения команды является ключевым архитектурным решением, предотвращающим неоднозначность и обеспечивающим, что каждая команда содержит только один тип первичного значения (float, int, bool или вектор).

---

## 2. Детальный Разбор Определений

### 2.1. Сообщение `ActuatorCommand`

-   **`command_id`**: Уникальный идентификатор команды для трассировки (тип `qiki.common.UUID` из `common_types.proto`).
-   **`actuator_id`**: Уникальный идентификатор целевого исполнительного механизма (тип `qiki.common.UUID`).
-   **`timestamp`**: Временная метка, когда команда была создана (тип `google.protobuf.Timestamp`).
-   **`oneof command_value`**: **Ключевая особенность.** Это поле-объединение гарантирует, что сообщение содержит только один из следующих типов значений:
    -   `float_value`: Для команд, требующих значения с плавающей точкой (например, процент тяги).
    -   `int_value`: Для целочисленных значений (например, режим работы).
    -   `bool_value`: Для булевых команд (например, включить/выключить).
    -   `vector_value`: Для векторных команд (например, направление движения) (тип `qiki.common.Vector3`).
-   **`unit`**: Единица измерения для значения команды (тип `qiki.common.Unit`).
-   **`CommandType` (enum)**: Стандартизированные типы команд, такие как `SET_VELOCITY`, `ROTATE`, `ENABLE`, `DISABLE`, `SET_MODE`. Это обеспечивает четкое понимание намерения команды.
-   **`confidence`**: Уровень уверенности в предложении (от 0.0 до 1.0), например, от AI-движка.
-   **`timeout_ms`**: Таймаут выполнения команды в миллисекундах. Важен для надежных операций.
-   **`ack_required`**: Флаг, указывающий, требуется ли подтверждение выполнения команды. Критичен для миссий, где важна обратная связь.
-   **`retry_count`**: Количество попыток выполнения команды при неудаче. Важен для отказоустойчивости.

---

## 3. Взаимодействие с Другими `.proto` Файлами и Модулями

-   **`protos/common_types.proto`**: Импортирует и использует `UUID`, `Vector3` и `Unit`.
-   **`services/q_sim_service/main.py`**: Получает сообщения `ActuatorCommand` для обновления `WorldModel`.
-   **`services/q_core_agent/core/interfaces.py`**: Интерфейс `IDataProvider` определяет метод `send_actuator_command()`, который принимает `ActuatorCommand`.
-   **`services/q_core_agent/core/bot_core.py`**: Отправляет сообщения `ActuatorCommand` на низкоуровневый уровень.
-   **`generated/actuator_raw_out_pb2.py`**: Python-код, автоматически сгенерированный из этого `.proto` файла, используется в приложении для работы с командами `ActuatorCommand`.
