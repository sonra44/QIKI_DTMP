# Анализ файла: `protos/fsm_state.proto`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл определяет формат сообщений для **снимков состояния конечного автомата (FSM)**. Он предоставляет стандартизированный, версионированный и трассируемый способ представления текущего операционного состояния агента и его истории переходов.

**Архитектурная роль:** `fsm_state.proto` является **каноническим определением состояния FSM** для межсервисного взаимодействия. Он обеспечивает:
-   **Консистентность:** Все компоненты системы используют одно и то же определение состояния FSM.
-   **Трассируемость:** Поле `history` позволяет отслеживать, как агент переходил из одного состояния в другое, что критически важно для отладки и анализа поведения.
-   **Машиночитаемость:** Использование `enum` для состояний и статусов переходов делает данные легко обрабатываемыми программно.

---

## 2. Детальный Разбор Определений

### 2.1. Перечисления (Enums)

-   **`FSMStateEnum`**: Стандартизированный перечень всех возможных операционных состояний FSM:
    -   `BOOTING`: Запуск системы.
    -   `IDLE`: Режим ожидания, готов к работе.
    -   `ACTIVE`: Активный режим, выполнение задач.
    -   `ERROR_STATE`: Состояние ошибки.
    -   `SHUTDOWN`: Завершение работы.
-   **`FSMTransitionStatus`**: Статус выполнения перехода состояния:
    -   `SUCCESS`: Переход выполнен успешно.
    -   `FAILED`: Переход не удался.
    -   `PENDING`: Переход находится в процессе выполнения.

### 2.2. Сообщение `StateTransition`

-   **Назначение:** Описывает один атомарный переход из одного состояния в другое.
-   **Поля:**
    -   `timestamp`: Временная метка перехода.
    -   `from_state` / `to_state`: Начальное и конечное состояния.
    -   `trigger_event`: Событие, вызвавшее переход (например, "BOOT_COMPLETE", "PROPOSALS_RECEIVED").
    -   `status`: Статус перехода (`FSMTransitionStatus`).
    -   `error_message`: Сообщение об ошибке, если переход не удался.

### 2.3. Сообщение `FsmStateSnapshot`

-   **Назначение:** Основное сообщение, представляющее полный снимок состояния FSM в определенный момент времени.
-   **Поля:**
    -   `snapshot_id`: Уникальный идентификатор для данного снимка состояния (тип `qiki.common.UUID` из `common_types.proto`).
    -   `timestamp`: Временная метка создания снимка.
    -   `current_state`: Текущее состояние FSM (`FSMStateEnum`).
    -   `history`: Повторяющееся поле, содержащее список сообщений `StateTransition`, формирующих журнал изменений состояния.
    -   `context_data`: Карта `string` к `string` для хранения дополнительных контекстных данных, связанных с текущим состоянием.
    -   `fsm_instance_id`: Идентификатор экземпляра FSM (тип `qiki.common.UUID`), полезен для систем с несколькими параллельными FSM.
    -   `state_metadata`: Карта `string` к `string` для хранения дополнительных метаданных (используется `conv.py` для сохранения DTO-специфичных полей).
    -   `source_module`: Модуль, инициировавший последнее изменение состояния.
    -   `attempt_count`: Количество попыток перехода в текущее состояние (полезно для отладки зацикливаний).

---

## 3. Взаимодействие с Другими `.proto` Файлами и Модулями

-   **`protos/common_types.proto`**: Импортирует и использует `UUID`.
-   **`services/q_core_agent/state/types.py`**: Определяет внутренний `FsmSnapshotDTO`, который является Python-представлением этой Protobuf-структуры.
-   **`services/q_core_agent/state/conv.py`**: Отвечает за конвертацию между `FsmSnapshotDTO` и `FsmStateSnapshot`.
-   **`services/q_core_agent/core/fsm_handler.py`**: Основной обработчик, который вычисляет и генерирует новые `FsmStateSnapshot` (через DTO-конвертацию).
-   **`services/q_core_agent/core/interfaces.py`**: Интерфейс `IDataProvider` определяет метод `get_fsm_state()`, который возвращает `FsmStateSnapshot`.
-   **`generated/fsm_state_pb2.py`**: Python-код, автоматически сгенерированный из этого `.proto` файла, используется в приложении для работы с состояниями FSM.
