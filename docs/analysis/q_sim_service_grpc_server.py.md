# Анализ файла: `services/q_sim_service/grpc_server.py`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл определяет класс `QSimGrpcServicer` и функцию `serve()`, которые совместно реализуют **gRPC-сервер для `Q-Sim Service`**. Его основная задача — предоставить сетевой интерфейс для взаимодействия с симулятором, позволяя `Q-Core Agent` (или любым другим gRPC-клиентам) отправлять команды и получать данные по сети.

**Архитектурная роль:** `grpc_server.py` является **точкой входа для сетевого взаимодействия** с симулятором. Он абстрагирует детали сетевого протокола (gRPC) от основной бизнес-логики `QSimService`. Это позволяет `Q-Sim Service` быть чистым Python-объектом, не знающим о сетевых вызовах, и при этом быть доступным в распределенной среде.

---

## 2. Детальный Разбор Функциональности

### 2.1. `QSimGrpcServicer`

-   **Назначение:** Реализует методы gRPC-сервиса `QSimAPI`, определенные в `q_sim_api.proto`.
-   **`__init__(self, qsim_service)`**: Инициализируется экземпляром `QSimService`. Все запросы, поступающие на gRPC-сервер, будут делегироваться этому экземпляру.
-   **`GetSensorData(request, context)`**: Обрабатывает gRPC-запрос на получение данных сенсоров. Делегирует вызов `self.qsim_service.generate_sensor_data()` и возвращает результат.
-   **`SendActuatorCommand(request, context)`**: Обрабатывает gRPC-запрос на отправку команды актуатору. Делегирует вызов `self.qsim_service.receive_actuator_command(request)`.
-   **`HealthCheck(request, context)`**: Предоставляет простой эндпоинт для проверки работоспособности gRPC-сервиса, возвращая статус `OK`.

### 2.2. Функция `serve(config, port)`

-   **Назначение:** Основная функция для запуска gRPC-сервера.
-   **Как работает:**
    -   Инициализирует экземпляр `QSimService`.
    -   Создает gRPC-сервер (`grpc.server`) с пулом потоков для обработки запросов (`futures.ThreadPoolExecutor`).
    -   Добавляет `QSimGrpcServicer` к серверу (`add_QSimAPIServicer_to_server`).
    -   Привязывает сервер к указанному порту (по умолчанию `50051`).
    -   Настраивает **обработчики сигналов** (`signal.SIGINT`, `signal.SIGTERM`) для **graceful shutdown** (корректного завершения работы) сервера при получении сигналов прерывания.
    -   Запускает сервер (`server.start()`) и ожидает его завершения (`server.wait_for_termination()`).

---

## 3. Взаимодействие с Другими Модулями

-   **`services/q_sim_service/main.py`**: `grpc_server.py` использует экземпляр `QSimService` для выполнения основной логики симулятора.
-   **`generated/q_sim_api_pb2_grpc.py`**: `QSimGrpcServicer` наследуется от `QSimAPIServicer` и использует функцию `add_QSimAPIServicer_to_server` для регистрации сервиса.
-   **`generated/q_sim_api_pb2.py`**: Использует Protobuf-сообщения, такие как `HealthResponse` и `Empty`.
-   **`services/q_sim_service/logger.py`**: Использует собственную систему логирования для `Q-Sim Service`.
-   **`grpc`**: Основная библиотека gRPC для Python.
