# Анализ файла: `services/q_sim_service/main.py`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл определяет класс `QSimService`, который является **ядром симуляционной среды** для проекта QIKI_DTMP. Его основная задача — поддерживать модель виртуального мира, генерировать данные сенсоров и обрабатывать команды исполнительных механизмов, поступающие от `Q-Core Agent`.

**Архитектурная роль:** `QSimService` выступает в роли **поставщика данных и исполнителя команд** для `Q-Core Agent`. Он полностью отделен от логики агента, что позволяет разрабатывать и развертывать симулятор независимо. Это критически важно для тестирования, отладки и масштабирования системы.

---

## 2. Детальный Разбор Функциональности

### 2.1. Инициализация (`__init__`)

-   Создает экземпляр `WorldModel`, который хранит текущее состояние симулируемого мира.
-   Инициализирует внутренние очереди (`sensor_data_queue`, `actuator_command_queue`) для имитации потока данных.

### 2.2. Генерация Сенсорных Данных (`generate_sensor_data()`)

-   **Как работает:** Запрашивает текущее состояние у `WorldModel` и на его основе создает Protobuf-сообщение `SensorReading`.
-   **Особенности:** На текущий момент генерирует данные только для `sim_lidar_front` и использует `scalar_data` (x-координату) из `WorldModel`.
-   **Зачем это нужно:** Это основной способ, которым симулятор "рассказывает" агенту о состоянии виртуального мира.

### 2.3. Прием Команд Актуаторов (`receive_actuator_command(command)`)

-   **Как работает:** Принимает Protobuf-сообщение `ActuatorCommand` от агента. Добавляет команду во внутреннюю очередь и, что самое важное, **обновляет `WorldModel`** на основе этой команды. Это позволяет агенту влиять на симулируемый мир.
-   **Особенности:** Включает базовую обработку переполнения очереди (`asyncio.QueueFull`), логируя предупреждение, если очередь заполнена.

### 2.4. Цикл Симуляции (`run()` и `step()`)

-   **`run()`**: Основной бесконечный цикл симулятора. Периодически (с интервалом `sim_tick_interval` из конфигурации) вызывает метод `step()`.
-   **`step()`**: Выполняет один шаг симуляции. Продвигает `WorldModel` на заданный `delta_time` и генерирует новые сенсорные данные.

---

## 3. Взаимодействие с Другими Модулями

-   **`services/q_sim_service/core/world_model.py`**: `QSimService` создает и управляет экземпляром `WorldModel`, который является его внутренней моделью мира.
-   **`generated/sensor_raw_in_pb2.py`**: Используется для создания Protobuf-сообщений `SensorReading`.
-   **`generated/actuator_raw_out_pb2.py`**: Используется для приема Protobuf-сообщений `ActuatorCommand`.
-   **`services/q_sim_service/logger.py`**: Использует собственную систему логирования, что подчеркивает его независимость от `Q-Core Agent`.
-   **`services/q_sim_service/config.yaml`**: Загружает конфигурацию симулятора (например, `sim_tick_interval`, `sim_sensor_type`).
-   **`services/q_sim_service/grpc_server.py`**: `QSimGrpcServicer` использует экземпляр `QSimService` для обработки gRPC-запросов от `Q-Core Agent`.
