# Анализ файла: `services/q_core_agent/core/rule_engine.py`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл определяет класс `RuleEngine`, который является реализацией `IRuleEngine`. Его основная задача — генерировать **«предложения» (Proposals)** для агента на основе набора **жестко заданных, детерминированных правил**. Эти правила представляют собой рефлексивное или заранее запрограммированное поведение агента.

**Архитектурная роль:** `RuleEngine` отвечает за **рефлексивное поведение** системы. В отличие от `NeuralEngine`, который может генерировать предложения на основе сложных моделей и обучения, `RuleEngine` обеспечивает немедленные, предсказуемые реакции на определенные условия. Это критически важно для реализации правил безопасности или базовой логики, которая не требует сложного анализа.

---

## 2. Детальный Разбор Логики

Основная логика сосредоточена в методе `generate_proposals(context)`.

### 2.1. Реализованное Правило: Безопасный Режим при Сбое BIOS

-   **Условие:** `if not context.is_bios_ok():`
    -   **Как работает:** Если `BiosHandler` определил, что система BIOS не в порядке (флаг `all_systems_go` равен `False`), то срабатывает это правило.
-   **Действие:** Генерируется `Proposal` с:
    -   `proposal_id`: Уникальный ID предложения (`rule_engine_safe_mode`).
    -   `source_module_id`: `rule_engine`.
    -   `type`: `Proposal.ProposalType.SAFETY` (высочайший приоритет).
    -   `priority`: `0.99` (очень высокий).
    -   `confidence`: `1.0` (полная уверенность).
    -   `justification`: "BIOS reported critical errors. Entering safe mode."
    -   `proposed_actions`: Включает `ActuatorCommand` для перевода системы в `ERROR_STATE` (предполагается, что это соответствует безопасному режиму).

### 2.2. Текущие Ограничения

-   **Важно:** На данный момент это **единственное правило**, реализованное в `RuleEngine`. Как было отмечено в `CLAUDE_CODE_AUDIT_FINDINGS.md`, если `context.is_bios_ok()` всегда возвращает `True` (как это происходит в текущей симуляции), то `RuleEngine` **никогда не сгенерирует ни одного предложения**.

---

## 3. Взаимодействие с Другими Модулями

-   **`agent.py`**: `QCoreAgent` вызывает `rule_engine.generate_proposals()` в каждом "тике" для получения предложений.
-   **`interfaces.py`**: `RuleEngine` реализует интерфейс `IRuleEngine`.
-   **`generated/proposal_pb2.py`**: Создает объекты `Proposal`.
-   **`generated/actuator_raw_out_pb2.py`**: Создает объекты `ActuatorCommand` в составе предложений.
-   **`agent.py` (`AgentContext`)**: Использует `context.is_bios_ok()` для оценки условий срабатывания правил.
