# Анализ файла: `shared/models/core.py`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл определяет **Pydantic-модели**, которые служат в качестве **контрактов данных для слоя коммуникации FastStream**. Он представляет собой современный, альтернативный подход к сериализации, десериализации и валидации данных в проекте QIKI_DTMP, дополняя или потенциально заменяя систему, основанную на Protobuf.

**Архитектурная роль:** `shared/models/core.py` является центральным элементом для **FastStream-интеграции**. Он обеспечивает:
-   **Типобезопасность:** Pydantic автоматически валидирует данные на основе аннотаций типов Python, что снижает количество ошибок в runtime.
-   **Автоматическая Сериализация/Десериализация:** Модели Pydantic могут быть легко преобразованы в JSON и обратно, что упрощает обмен сообщениями.
-   **Гибкость:** Предоставляет альтернативный механизм обмена данными, который может быть более удобным для определенных сценариев (например, для асинхронного обмена сообщениями через NATS).

---

## 2. Детальный Разбор Ключевых Моделей

### 2.1. Базовая Конфигурация (`ConfigModel`)

-   **`ConfigModel`**: Базовый класс для всех Pydantic-моделей в этом модуле. Он определяет общие настройки, такие как `alias_generator=to_camel`, что автоматически преобразует имена полей из `snake_case` (Python) в `camelCase` (JSON).

### 2.2. Перечисления (Enums)

-   **`FsmStateEnum`**: Определяет состояния конечного автомата для FastStream-контекста. Аналогичен `FsmState` из `types.py`.
-   **`DeviceStatusEnum`**: Статусы устройств (например, `OK`, `ERROR`).
-   **`SensorTypeEnum`**: Типы сенсоров (например, `LIDAR`, `CAMERA`).

### 2.3. Вспомогательные и Вложенные Модели

-   **`MessageMetadata`**: Содержит метаданные сообщения (ID, корреляционный ID, временная метка, источник, тип). Используется для трассировки и отладки.
-   **`FsmTransition`**: Описывает один переход FSM, включая `from_state`, `to_state` и `event_name`.
-   **`DeviceStatus`**: Статус отдельного устройства, включая `device_id`, `device_name` и `status`.

### 2.4. Основные Модели Данных (Snapshots)

-   **`FsmStateSnapshot`**: Представляет снимок состояния FSM. Содержит `current_state`, `previous_state`, историю переходов и контекстные данные. Аналогичен `FsmStateSnapshot` из Protobuf, но реализован на Pydantic.
-   **`BiosStatus`**: Отчет о состоянии BIOS. Включает список `DeviceStatus` и **вычисляемое поле `all_systems_go`**, которое автоматически определяет общий статус системы на основе статусов отдельных устройств.
-   **`SensorData`**: Представляет данные, полученные от сенсора. Поддерживает различные типы данных (`scalar_data`, `vector_data`, `string_data`) через `Optional` поля. Включает **валидатор `validate_data_presence`**, который гарантирует, что хотя бы одно поле данных заполнено.

### 2.5. Модели для Сообщений (Запросы и Ответы)

-   **`CommandMessage`**: Определяет структуру команды, отправляемой по FastStream (имя команды, параметры, метаданные).
-   **`ResponseMessage`**: Определяет структуру ответа на команду. Включает `request_id`, `payload`, `error` и `success`. Содержит **валидатор `validate_response_consistency`**, который проверяет, что `error` присутствует только при `success=False`.

---

## 3. Взаимодействие с Другими Модулями

-   **`services/faststream_bridge/app.py`**: Является основным потребителем этих моделей. Он использует их для определения структуры сообщений, которые публикуются и потребляются через NATS-брокер.
-   **`tests/integration/test_faststream_bridge.py`**: Использует эти модели для интеграционного тестирования FastStream-моста, проверяя полный цикл обмена сообщениями.
-   **`tests/models/test_pydantic_compatibility.py`**: Содержит специализированные тесты для валидации и совместимости этих Pydantic-моделей.
-   **`requirements-faststream.txt`**: Указывает `pydantic` как ключевую зависимость для этого слоя.
