# Анализ файла: `services/q_sim_service/core/world_model.py`

**Версия документации:** 1.0  
**Дата анализа:** 2025-09-03

---

## 1. Назначение и Архитектурная Роль

Этот файл определяет класс `WorldModel`, который является **единственным источником правды для состояния симулируемой среды**. Он хранит и управляет физическими свойствами бота внутри симуляции, такими как его позиция, направление, скорость и уровень заряда батареи.

**Архитектурная роль:** `WorldModel` инкапсулирует **логику физической симуляции**. Он отделен от `QSimService`, что позволяет в будущем легко заменять или расширять модель мира (например, на 3D-модель, более сложную физику или взаимодействие с несколькими объектами) без изменения основного сервиса симуляции.

---

## 2. Детальный Разбор Функциональности

### 2.1. Инициализация (`__init__`)

-   При создании экземпляра `WorldModel` инициализируются начальные параметры бота: `position` (как `Vector3`), `heading` (направление в градусах), `battery_level` и `speed`.

### 2.2. Обновление Состояния (`update(command)`)

-   **Как работает:** Этот метод принимает Protobuf-сообщение `ActuatorCommand` и изменяет внутреннее состояние `WorldModel` в соответствии с командой.
    -   **Пример:** Если `actuator_id` соответствует мотору (`motor_left` или `motor_right`) и `command_type` — `set_velocity_percent`, то `speed` бота обновляется. Если `command_type` — `rotate_degrees_per_sec`, то изменяется `heading`.
-   **Особенности:** На текущий момент реализована **упрощенная кинематическая модель**. В реальной симуляции это потребовало бы более сложной физики и учета динамики.

### 2.3. Продвижение Симуляции (`step(delta_time)`)

-   **Как работает:** Этот метод продвигает симуляцию на заданный интервал времени `delta_time`.
    -   **Обновление позиции:** Позиция бота (`position.x`, `position.y`) обновляется на основе текущей `speed` и `heading` с использованием тригонометрических функций. Предполагается, что 0 градусов — это +Y (Север), 90 градусов — +X (Восток).
    -   **Разряд батареи:** Реализован простой механизм разряда батареи (`battery_level`).
-   **Зачем это нужно:** Метод `step()` является основой для пошаговой симуляции, позволяя миру эволюционировать во времени.

### 2.4. Получение Состояния (`get_state()`)

-   **Как работает:** Возвращает текущее состояние `WorldModel` в виде словаря, содержащего позицию, направление, уровень заряда батареи и скорость.
-   **Зачем это нужно:** Этот метод используется `QSimService` для получения актуальных данных, которые затем преобразуются в сенсорные показания для агента.

---

## 3. Взаимодействие с Другими Модулями

-   **`services/q_sim_service/main.py`**: `QSimService` создает экземпляр `WorldModel`, вызывает его методы `update()` для применения команд и `get_state()` для получения данных.
-   **`generated/actuator_raw_out_pb2.py`**: `WorldModel` принимает Protobuf-сообщения `ActuatorCommand`.
-   **`generated/common_types_pb2.py`**: Использует `Vector3` для представления позиции бота.
-   **`services/q_sim_service/logger.py`**: Использует независимую систему логирования для отладки шагов симуляции.
