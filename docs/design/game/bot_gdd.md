# QIKI DTMP — Бот (GDD v0, боевой черновик)

> ⚠️ **Источник правды:** `docs/design/hardware_and_physics/bot_source_of_truth.md`.
> Этот файл — GDD (концепция/механики) и не должен быть единственным источником аппаратных чисел.

Версия: 0.1.3 (боевой черновик). Фокус: только гейм‑дизайн поведения и механик бота без кода.

## 1. Вид и геометрия
- Корпус: додекаэдр (12 граней), центр масс в центре.
- Хардпоинты: каждая грань — унифицированный слот под модуль (сенсор/радиатор/антенна/бронепанель).
- Ориентация осей: локальные X/Y/Z задаются инерциальной моделью; базовая калибровка симметрична.
- Стыковочные байонеты: 2 шт., на противоположных гранях; по умолчанию убраны под створки с магнитным замком. Назначение: стыковка, питание (зарядка быстрая/штатная от внешних модулей), передача данных.
- Каскадная стыковка (bridge): при занятом порту станции второй бот может стыковаться к первому и получать питание/связь транзитом; без привилегий и монополизации порта.

## 2. Двигательная установка (RCS)
- Состав: 16 сопел RCS, организованных в 4 кластера × 4 сопла.
- Размещение кластеров (Вариант A — для MVP): 4 кластера во врезке корпуса на 4 лицах, отобранных тетраэдрически (равномерно по сфере). Кластеры «встроены» в корпус.
- Ориентация сопел в кластере (по умолчанию):
  - Каждое сопло наклонено под углом α ≈ 40° от нормали грани.
  - Азимутальные развороты: 0°, 90°, 180°, 270° относительно локальной оси грани.
  - Такая схема позволяет формировать как чистые трансляции (почти нулевой момент), так и моменты для roll/pitch/yaw (диагональными парами).

### Принцип симметрии тяги (без перекосов)
- Цель: в любом направлении доступная эффективная тяга одинакова (без «выгодных» направлений).
- Достижение на 4 кластерах:
  1) Для чистых переводов всегда используются Zero‑Torque Translation наборы (ZTT) — 2 или 4 сопла, подобранные так, чтобы суммарный момент Σ(r×F)=0.
  2) Вместо «среза» тяги (cap) применяется группировка: при необходимости подключаются дополнительные сопла в симметричных кластерах так, чтобы максимум по любому направлению достигался одинаковым по мощности симметричным набором (без перекоса и без ограничения сверху).
  3) Алгоритм выбора: по целевому вектору v подбираются симметричные сопла в разных кластерах с одинаковыми плечами относительно ЦМ; проекции нормируются так, чтобы ΣF≈F·v и Σ(r×F)=0.
  4) Уровни наборов: ZTT (минимальный чистый перевод) и FTG (Full Thrust Group — полный симметричный набор). Политика: одинаковый «максимум» достигается включением FTG для любого направления.

## 3. Управленческие группы тяги
- Thrust Map v0: два уровня для каждого направления X/Y/Z —
  - ZTT (минимум): чистый перевод с нулевым моментом (экономичный режим).
  - FTG (максимум): полный симметричный набор, одинаковый для всех направлений (единый потолок тяги без перекосов). (Таблица TBD.)
- Torque Map v0 (вращение): диагональные пары в кластерах для Roll/Pitch/Yaw. (Таблица TBD.)

### 3.1 Гибкая комбинаторика тяги (override)
- Разрешено произвольное объединение и распределение сопел/кластеров по направлению задачи (например, «+4 на Z+ и +1 на Z-» для тонкой подстройки суммарной тяги).
- Режимы использования:
  - AUTO: только ZTT/FTG (чистая симметрия без перекосов).
  - ADAPTIVE: планировщик подбирает произвольные комбинации, а контроллер автоматически компенсирует паразитный момент по возможности.
  - MANUAL_OVERRIDE: ручное принудительное задание комбинации (разработческий/отладочный режим), под жёсткими лимитами безопасности.
- Планировщик импульсов: временное мультиплексирование импульсов («PWM» групп сопел) для достижения нужных пропорций тяги без накопления момента за окно Δt.
- Ограничения стабильности: если компенсация момента невозможна, вводится предел |крутящий момент| ≤ τ_max и/или разбивка манёвра на микрошаги с промежуточной компенсацией.
- Безопасность: Brake override имеет наивысший приоритет; соблюдение тепловых/энергетических лимитов обязательно.
- Телеметрия: логируются активные группы, суммарная тяга и оценка суммарного момента за окно управления.

### 3.2 Профиль тяги (ThrustProfile)
- Назначение: задать последовательность сегментов по времени с требуемой «мощностью» тяги в процентах.
- Сегмент: { длительность_sec, уровень_pct (0..100), направление/группа (X/Y/Z или вектор), опционально: плавный вход/выход (ramp) }.
- Исполнение:
  - Если сопла поддерживают дросселирование — уровень_pct трактуется как реальная доля тяги.
  - Если сопла импульсные — уровень_pct реализуется через PWPF (доля включения за окно Δt), сохраняя целевой профиль по времени.
- Ограничения и прерывания: соблюдаются SoC/тепло/момент; Brake override прерывает профиль немедленно; при риске — сегмент дробится на микрошаги с промежуточной компенсацией.
- Совместимость с режимами: профиль применим к ZTT/FTG/ADAPTIVE; для ZTT/FTG приоритет — нулевой момент; в ADAPTIVE контроллер добавляет компенсацию.

## 4. Энергосистема и источники
- Источники энергии (по умолчанию): две симметричные солнечные панели, установленные парно (левая/правая) с равными массой и плечом — исключаем перекос по моменту.
- Вариативность источников (взаимозаменяемые модули): вместо/вместе с панелями может устанавливаться генератор распада (RTG‑класс) или генератор непрерывного окисления. Требование: симметричная установка (парно) либо компенсирующая масса/контрмодуль.
- Центральная батарея: основной накопитель/буфер непрерывной мощности.
- Быстрые конденсаторы: буфер пиков, стабилизация шины, питание импульсов RCS.
- Потоки:
  - Источники → батарея (базовый поток) → заряд конденсаторов при наличии запаса.
  - Импульсы RCS в приоритете питаются из конденсаторов; батарея догружает при недостатке.
- Пороги по состоянию заряда конденсаторов (SoC_cap):
  - T_boost = 0.6 — разрешение буст‑импульсов.
  - T_hold = 0.3 — ниже этого только стабилизация и заряд.
 - Контроллеры и политика:
   - MPPT‑контроллеры на солнечных панелях для максимальной выработки.
   - Power‑path (OR‑ing FET) между источниками/батареей/шиной для управления потоками.
   - Peak‑shaving: пики нагрузки (RCS) покрываются конденсаторами; батарея держит базовый уровень.
   - Ограничения по ESR/току конденсаторов учитываются при расчёте длительности/частоты импульсов.

## 5. Режимы движения (без рекуперации)
- Idle/Стабилизация: удержание ориентации малыми импульсами, приоритет зарядки конденсаторов.
- Манёвр‑ориентация: точные микроимпульсы для наведения, с контролем порогов SoC_cap.
- Перелёт: Burn → Coast → Brake.
  - Burn: набор скорости строго вдоль целевого вектора (группы перевода).
  - Coast: инерционный участок, дозаряд и тепловое охлаждение, мелкая стабилизация.
  - Brake: контрвектор burn для гашения скорости/точной остановки.
- SAFE: запрет буста, только стабилизация и заряд; Brake override всегда разрешён.

## 6. Тестовый шаг (MVP‑сценарий)
- Вход: целевая ориентация и/или малый трансляционный сдвиг.
- Правила:
  - Если SoC_cap ≥ T_boost и ошибка ориентации > ε — короткий импульс из конденсаторов.
  - Если SoC_cap < T_hold — запрет манёвра; только стабилизация и заряд.
  - Между импульсами — rate‑limit (пауза не меньше Δt_min).
- Выход: снижение ошибки ориентации/позиции, лог расхода энергии и тепла.

## 7. Параметры по умолчанию (MVP)
- Минимальная длительность импульса Δt_min = 30 мс; пауза между импульсами ≥ Δt_min.
- Лимит непрерывного burn: 3 с, затем обязательный cooldown (тепловой лимит, скорость рассеяния — TBD).
- Рекуперации нет: импульс создаёт скорость; гашение только контртягою.

## 8. Правила безопасности
- Brake override: в любой момент допустимо немедленное торможение при угрозе.
- В SAFE режиме: запрещены буст‑импульсы; приоритет стабилизации и зарядки.
- Байонет: авто‑блокировка/размыкание при аварии, защита от обратной подачи, лимиты тока/температуры в режиме моста; ручное аварийное расцепление.
- Коммуникации: EMCON (ограничение излучения), авто‑снижение мощности, запрет NBL при аварии/перегреве/низком SoC_cap; IDS/анти‑intrusion в фоновом режиме.

## 9. Открытые вопросы (TBD)
- Точная привязка «какие именно 4 грани» (индексы/схема) — оформить приложением.
- Точные углы α/азимутов для кластеров (баланс между моментом и переводом).
- Подробные таблицы Thrust Map v0 / Torque Map v0.
- Коммуникации: параметры NBL (дальность/модуляция/бюджет), EMCON‑профили, максимальная глубина каскада через байонеты.
- Сенсоры: диапазоны/погрешности IMU/термо/радиации, частоты опроса, калибровка и процедуры прогрева; типы датчиков для рад‑канала (полупроводник/Г‑М).

## 10. Глоссарий
- Burn/Coast/Brake — фазы перелёта: разгон/баллистика/торможение.
- SoC_cap — степень заряда конденсаторов (0..1).
- Brake override — приоритетная команда торможения, перекрывающая другие действия.
- NBL — Neutrino Burst Link: нейтринный канал (игровая условность: высокая проникаемость, субсветовая задержка).
 - IMU — Inertial Measurement Unit: гироскопы и акселерометры (+магнитометр).

## История версий
- 0.1 — начальный боевой черновик: форма, RCS‑кластера (Вариант A), энергия, режимы, тест‑шаг, параметры по умолчанию, безопасность.
- 0.1.1 — добавлены байонетные стыковочные коннекторы (двойные), режим моста и каскадной стыковки; обновлены разделы Power/Comms/Safety.
- 0.1.2 — добавлен Comms Core: фоновый приём/анализ/ретрансляция, закрытые каналы (E2E), QoS/EMCON; нейтринный NBL как бэкхолл; глоссарий/вопросы.
- 0.1.3 — расширен сенсорный комплект: температура/радиация/IMU/стыковка, калибровки и события; дополнены Sensor Plane и R.L.S.M.

## 11. «ЧИПСЕТ‑СХЕМА» (внутренняя прошивка)
Цель: локальный слой управления железом (питание/тяга/сенсоры/безопасность) с быстрыми контурами и автономным SAFE. Q‑Core Agent сверху задаёт цели и получает телеметрию.

- Power Plane (энергия):
  - Power Supervisor: управление источниками (панели/RTG/окисление), SoC батареи/конденсаторов, приоритеты, load‑shedding.
  - PDU: коммутация линий, ограничение пиков, симметрия нагрузок.
  - Пороговая логика: T_boost/T_hold, правила заряд/разряд, аварийные отсечки.
  - Dock Power Bridge: сквозное питание через байонет (заряд/разряд), антиобратные ключи/контроль полярности, лимиты по току/мощности, мягкий пуск.
  - NBL Power Budgeter: лимиты пиковой/средней мощности для NBL; разрешение передачи при SoC_cap ≥ T_nbl и норме по термо.

- Propulsion Plane (тяга):
  - Control Allocator: выбор ZTT/FTG/ADAPTIVE наборов под целевой вектор; гарантирует Σ(r×F)=0 при возможности.
  - PWPF‑модулятор (или bang‑bang с гистерезисом) для импульсных thrusters.
  - PWM Planner: временное мультиплексирование импульсов для пропорций без накопления момента.
  - Thermal Guard: лимиты непрерывного burn, cooldown.
  - Thrust Synthesizer: формирование команд на кластеры/сопла.

- Sensor Plane (сенсоры):
  - Датчики: IMU (3× гироскоп, 3× акселерометр, опц. 3× магнитометр), термодатчики (корпус/кластеры RCS/батарея/конденсаторы/ПДУ), радиация (дозиметр/счётчик событий), датчики байонета (замок/контакт/ток/температура), датчики близости стыковки.
  - Синхронизация времени и фильтрация для быстрых контуров; калибровка bias/scale/cross‑axis, термокомпенсация, онлайн‑оценка дрейфа.
  - Health‑мониторинг: self‑test, пороги temp/rad/shock, флаги деградации; связка с Thermal Guard и Safety.
  - Runtime‑снимки для BotCore (ориентация, ΣF, SoC_cap, температуры, дозы/потоки радиации).

- Safety Plane (безопасность):
  - Mode Manager: Idle/Manoeuvre/Burn/Coast/Brake/Dock/Bridge/EMCON/SAFE.
  - FDIR: обнаружение/изоляция отказов, Brake override при угрозе.
  - Sun‑track Idle (в SAFE): ориентация на максимум солнечного потока для ускоренного восстановления SoC_cap, буст запрещён.

- Comms Plane (связь с агентом):
  - Команды от Q‑Core Agent: target_vec, level {ZTT|FTG|ADAPTIVE}, duration/max_accel, thrust_profile (список сегментов), brake_policy, safety_bounds (τ_max, T_boost/T_hold).
  - Телеметрия агенту: SoC_cap, мощность источников/батареи, температура, активные группы, ΣF, Σ(r×F), прогресс thrust_profile, текущий режим, флаги отказов.
  - Comms Core:
    - Channel Manager: мультиплекс фоновых/приоритетных потоков, закрытые каналы (E2E), QoS‑классы (control/telemetry/bulk/science), бестселект маршрутов.
    - Analyzer/IDS: фоновый анализ метаданных/аномалий без доступа к содержимому E2E; алерты intrusion/threat.
    - Background ingest/forward: приём/ретрансляция «в фоне» под бюджет SoC/термо; ограничение полосы/мощности.
    - Data Bridge интеграция: мост через байонет и каскад стыковок; немонополизируемый.
  - Neutrino Burst Link (NBL):
    - Свойства: высокая проникаемость и низкая уязвимость к помехам; задержка субсветовая (игровая условность), дальность/модуляция — TBD.
    - Режимы: burst (импульсная передача для массы данных) и stream (устойчивый малополосный канал).
    - Энергия: высокие пиковые затраты; разрешение при SoC_cap ≥ T_nbl и норме по термо; EMCON‑ограничения.
    - Безопасность: LPI/LPE‑профили, маскирование, ключевая ротация; невозможность «монополизировать» линк.

- Тайминг:
  - Быстрый контур 200–500 Гц (стабилизация/тяга), средний 10–50 Гц (энергия/термо), медленный 1–5 Гц (режимы/диагностика).

## 12. Гибридная система восприятия R.L.S.M
Единая подсистема: радар + лидар + спектрометр + магнитометр. Цель — круговой обзор, точная геометрия близко, анализ состава и полей; единый вывод для навигации и предотвращения столкновений.

- Роли сенсоров
  - Радар (360°): непрерывный круговой обзор, дальнее обнаружение крупных/средних объектов, оценка относительных скоростей (доплер), «грубая» карта окрестности.
  - Лидар: высокое разрешение геометрии, мелкие объекты вне порога радара, уточнение контуров/расстояний, режимы точечного наведения и веерных сканов.
  - Спектрометр: анализ состава/следов (пыль/газ/поверхности), маркеры ресурсов/опасных веществ.
  - Магнитометр: карта магнитного поля, аномалии/градиенты, вспомогательная навигация/диагностика среды.

- Пайплайн слияния (Perception Plane)
  1) Синхронизация времени и калибровка.
  2) Детекция по каждому сенсору (радарные цели, облака точек лидара, спектральные метки, магнитные аномалии).
  3) Ассоциация и трекинг объектов (объединение наблюдений, фильтры состояния).
  4) Слияние в представления: Occupancy/Grid (окружение), список треков с атрибутами, карты состава/поля.
  5) Оценка риска (TCAS‑подобная логика): пороги времени‑до‑сближения, класс угрозы, триггеры Brake override/манёвра уклонения.

- Режимы работы
  - Navigation (дефолт): радар 360° непрерывно; лидар пачками/по запросу для уточнения; спектро/магнито — в фоне по бюджету.
  - Approach/Docking: приоритет лидара (высокая частота/точность), радар как охранный периметр.
  - Cartography: лидар+радар для картографирования; накопление Occupancy/Grid.
  - Science: приоритет спектро/магнито; снижение частоты лидара по бюджету.
  - SAFE: минимально достаточный набор (радар низкой мощности + IMU); экономия энергии.

- Сенсоры среды и техсостояния
  - Температура: матрицы термодатчиков по корпусу/узлам, карта тепла для Thermal Guard и диагностики.
  - Радиация: дозиметр (накопленная доза) и счётчик событий (мгновенный фон/всплески), триггеры rad_high/rad_spike.
  - IMU: ускорения/угловые скорости как опорная инерциальная навигация; детектор ударов/вибраций (shock).
  - Стыковка: контакт/замок/выравнивание (близость), контроль тока/температуры байонета.

- Энергобюджет и планирование
  - Duty‑cycle менеджер: частоты/длительности сканов под SoC_cap и текущую генерацию.
  - При дефиците — деградация: урезать частоту лидара, оставить радар 360° на низком уровне.

- Интерфейсы к агенту
  - Выходы: Occupancy/Grid, список треков (id, позиция/скорость, размер, класс, риск), карты состава/полей.
  - События: threat_high (предложение Brake/уклонения), map_update, science_hit (интересный состав/аномалия).
  - Управление: профили режимов, сектора приоритета для лидара, лимиты по бюджету.

- Безопасность
  - Любая высокая угроза генерирует триггер Brake override.
  - Журнал рисков и подтверждений действий.
## 13. Байонетный стыковочный коннектор (двойной)
Цель: универсальный механико‑электрический интерфейс стыковки для питания, обмена данными и каскадного моста между ботами/станцией.

- Конфигурация
  - Количество: 2 шт., расположены на противоположных гранях корпуса (симметрия).
  - Механика: убираемые под створки; магнитный замок, датчик положения/замка.
  - Электрика: силовые контакты (заряд/питание быстрая/штатная), сигнальные линии/данные.

- Режимы
  - Dock: механическая фиксация и аутентификация стыка.
  - Charge/Power: зарядка от внешнего узла или питание нагрузки через бот.
  - Data: двунаправленный обмен телеметрией/командами.
  - Bridge: транзит питания и данных бот↔станция↔бот (каскадная стыковка).

- Политики и ограничения
  - Без монополизации: стык не эксклюзивен; второй бот может присоединиться к первому для получения питания/связи.
  - Электробезопасность: антиобратные ключи, мягкий пуск, лимиты по току/температуре, авторазмыкание при аварии.
  - Сеть: профиль моста (L2/L3) и QoS настраиваются; TBD: максимальная глубина каскада и бюджет мощности на каскад.

- Телеметрия/управление
  - Статусы: retracted/locked/open/docked/bridging, ток/напряжение/температура, роль (source/sink/relay).
  - Команды: open/close/dock/undock, set_bridge_profile(qos, limits), set_power_limits.

## 14. Коммуникационный стек и NBL (Comms Core)
Цель: высоконадёжная связь с фоновым приёмом/анализом/ретрансляцией, закрытыми каналами и опциональным нейтринным бэкхоллом.

- Архитектура
  - Канальный уровень: Channel Manager (до N одновременных), классы QoS, приоритеты, EMCON‑профили.
  - Крипто: E2E, пост‑квантовая стойкость (игровая допущ.), ротация ключей, безопасные «закрытые каналы».
  - Маршрутизация: локальные радиоканалы/оптика, байонетный Data Bridge, NBL‑бэкхолл; выбор по бюджету/риску/полосе.

- Возможности
  - Background ingest/forward: приём и пересылка данных в фоне под энергетический бюджет.
  - Closed channels: приватные E2E‑туннели для управления/науки/сервиса, без монополизации ресурса.
  - Аналитика: IDS/аномалия‑детектор по метаданным потоков, алерты/митигирующие действия.

- NBL (нейтринный канал)
  - Свойства: проходит через препятствия, трудно перехватывается; задержка ограничена скоростью распространения (субсветовая, не «нулевая»).
  - Режимы: burst/stream; планировщик слотов с лимитом по SoC/термо.
  - Ограничения: энергоёмкость, требования к SoC_cap и охлаждению; EMCON‑режимы.

- Интерфейсы к агенту
  - Управление: create_channel(kind, e2e, qos), set_emcon(level), set_nbl(enabled, limits), bridge_config.
  - События: link_up/down, emcon_enter/exit, intrusion_alert, nbl_budget_low.

- Примечание (игровая условность)
  - NBL повышает проникаемость и устойчивость к помехам, но не нарушает причинность и не «обнуляет» задержки; финальные параметры TBD лором/балансом.

## 15. Сенсорный комплект (Sensor Suite)
Цель: полный перечень датчиков для навигации, безопасности и технической диагностики с едиными профилями опроса/калибровки.

- Перечень датчиков
  - IMU: 3× гироскоп, 3× акселерометр, опц. 3× магнитометр (6/9 DoF).
  - Температура: корпус/силовая плата/ПДУ/батарея/конденсаторы/кластеры RCS/байонет; термоматрицы для теплокарт.
  - Радиация: дозиметр (накопленная доза), счётчик событий (γ/нейтрон, если применимо), флаги rad_high/rad_spike.
  - Стыковка: контакт/замок/выравнивание, датчики тока/напряжения/температуры байонета.
  - Энергия: ток/напряжение по линиям питания, SoC батареи/конденсаторов (под Power Plane).
  - Вспомогательные (опционально): солнечный датчик, звёздный трекер (TBD лор/баланс).

- Частоты/профили
  - Быстрые: IMU 200–500 Гц (стабилизация/навигация).
  - Средние: температура/энергия 10–50 Гц (термоконтроль/питание).
  - Медленные: радиация/диагностика 1–5 Гц (фон/доза).

- Калибровка и компенсации
  - Bias/scale/cross‑axis для IMU; термокомпенсации; онлайн‑оценка дрейфа.
  - Радиакалибровка: нулевая линия/фон, время интеграции; антидребезг всплесков.
  - Теплокарты: интерполяция матриц, связь с Thermal Guard.

- События/интерфейсы
  - События: temp_high_{узел}, rad_high, shock_detected, dock_contact, lock_engaged.
  - Управление: sensor_profile({fast,balanced,eco}), limits(temp/rad), калибровка (start/accept).
