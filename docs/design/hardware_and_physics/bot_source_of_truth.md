# Bot Source of Truth (QIKI_DTMP)

## 0) Назначение и статус
Этот документ — **единый источник правды** по *структуре* бота (геометрия/стыковка), *двигательной подсистеме* (RCS и принципы управления) и *формату hardware‑контрактов/сборки профиля*.

Он собран без дублирования из двух документов:
- `docs/design/game/bot_gdd.md` — концепция и механики (GDD).
- `docs/design/hardware_and_physics/bot_physical_specs_design.md` — аппаратные контракты, координаты, пайплайн генерации.

Если возникает конфликт формулировок — приоритет у **машиночитаемых конфигов** (см. раздел 7), затем у этого документа.

## 1) Концепция управления (QIKI, бот и оператор)
Бот — физическая платформа: корпус и «железо» с низкоуровневыми контурами (BIOS‑подобный слой, FSM и др.).  
QIKI — интеллектуальное ядро и личность бота: принимает решения, управляет подсистемами и выполняет миссии.  
Оператор — гость: не управляет ботом напрямую, взаимодействует с QIKI естественным языком, получает телеметрию и отчёты.  
Коммуникация строится как постановка целей и запросов оператором → планирование/исполнение QIKI → обратная связь (состояние/отчёт/рекомендации).

## 2) Границы (что описываем здесь)
- Форм‑фактор корпуса, точки стыковки, базовые инженерные допущения.
- RCS (количество сопел, кластеризация, симметрия тяги, режимы управления, импульсное управление на уровне принципа).
- Контрактный формат аппаратных компонентов и процесс генерации runtime‑конфигураций.

Не является целью: полный гейм‑дизайн, сценарии миссий, баланс параметров, таблицы Thrust Map/Torque Map (они могут жить отдельно, но должны ссылаться на этот документ).

## 3) Система координат
- Глобальная ось: **Z вверх, X вперёд, Y влево**.
- Центр масс (относительно геометрического центра): **`[0.0, 0.0, 0.1]` м**.
- Формат позиции: `[x_m, y_m, z_m]`.
- Формат ориентации: `[roll, pitch, yaw]` в радианах.

## 4) Геометрия и модульность корпуса
- Корпус: **додекаэдр (12 граней)**.
- Хардпоинты: каждая грань — унифицированный слот под модуль (сенсор/радиатор/антенна/панель).

## 5) Стыковка (байонеты и bridge)
- Стыковочные байонеты: **2 порта** на противоположных гранях.
- Назначение: стыковка, питание (зарядка/штатное питание), передача данных.
- Bridge/каскад: при занятом порту станции второй бот может стыковаться к первому и получать питание/связь транзитом.

## 6) Двигательная установка (RCS)
### 5.1 Состав и компоновка
- Состав: **16 сопел RCS**, организованных как **4 кластера × 4 сопла**.
- Размещение кластеров (вариант для MVP): 4 кластера распределены по корпусу «тетраэдрически» (равномерно по сфере), кластеры встроены в корпус.
- Ориентация сопел в кластере (по умолчанию, как принцип): наклон примерно **α ≈ 40°** от нормали грани, азимутальные развороты **0°/90°/180°/270°** относительно локальной оси грани.

### 5.2 Принцип симметрии тяги (без «выгодных» направлений)
Цель: обеспечить одинаково доступную эффективную тягу во всех направлениях, избегая перекосов.

- Для чистых переводов используются наборы **ZTT (Zero‑Torque Translation)** — 2 или 4 сопла, подобранные так, чтобы суммарный момент был близок к нулю (Σ(r×F)=0).
- Для достижения одинакового «потолка» тяги используется **FTG (Full Thrust Group)** — симметричный полный набор, который даёт одинаковый максимум для любого направления.

### 5.3 Режимы управления тягой
- `AUTO`: только ZTT/FTG (жёсткая симметрия).
- `ADAPTIVE`: планировщик может использовать произвольные комбинации, компенсируя паразитный момент по возможности.
- `MANUAL_OVERRIDE`: ручное задание комбинации для отладки под жёсткими лимитами.

### 5.4 Импульсное управление (на уровне принципа)
- Поддерживается импульсная модуляция (PWM/PWPF/bang‑bang) для сопел без непрерывного дросселирования.
- Планировщик импульсов может мультиплексировать включения во времени, чтобы достигать нужных пропорций тяги без накопления момента за окно Δt.

## 7) Hardware contracts: формат и сборка профиля
### 6.1 Машиночитаемые контракты компонентов
Каждый аппаратный компонент описывается JSON‑контрактом (id/type/точка крепления/лимиты/режим управления/латентность и т.п.).
Примеры двигательной установки и сенсора заданы в исходном design‑документе.

### 6.2 Контроль целостности
- Вводится `hardware_profile_hash` (SHA256) от отсортированного набора контрактов.
- Хэш должен попадать в производные артефакты (например, `bot_config.json`) и в телеметрию/логи для трассируемости.

### 6.3 Цепочка генерации
1) Человек редактирует источник‑документ со вставками JSON‑контрактов.
2) `qiki-docgen convert` → собирает `bot_physical_specs.json`.
3) `qiki-docgen build-bot-config` → генерирует runtime `bot_config.json`.

## 8) Каноничные машиночитаемые артефакты (приоритет выше текста)
- RCS геометрия/лимиты сопел: `config/propulsion/thrusters.json`.
- Состав подсистем/каналов: `shared/specs/BotSpec.yaml`.
- Runtime hardware profile (используется логикой агента): `src/qiki/services/q_core_agent/config/bot_config.json`.

## 9) Связанные документы (не «источник правды»)
- Концепция/механики (GDD): `docs/design/game/bot_gdd.md`.
- Исходный документ про аппаратные контракты/пайплайн: `docs/design/hardware_and_physics/bot_physical_specs_design.md`.
