# Расширение радара и визуализации в проекте QIKI_DTMP

> **REFERENCE/BACKLOG ONLY (NOT CANON)**  
> Этот документ — справка/сводка идей и бэклога по развитию радара (Phase 3+).  
> Он **не является** каноном приоритетов. Канон “что делаем сейчас” — `~/MEMORI/ACTIVE_TASKS_QIKI_DTMP.md`.

## 1. Текущее состояние

* **Радар v1 реализован полностью**, однако визуальная часть и интерфейс отображения данных пока готовы лишь на ~10 %. В документации указано, что текущая версия радара передаёт кадры и треки, но дальнейшая агрегация, классификация и визуальный интерфейс отсутствуют (см. `RADAR.md`, `docs/radar_phase2_roadmap.md`, `docs/asyncapi/radar_v1.yaml`).
* **Отображение в консоли** построено на ASCII-графике: `RadarVisualization` рисует сетку символов, круговые рамки и точки детекций на матрице символов (см. `src/qiki/services/operator_console/ui/charts.py`). Такой интерфейс прост, но не предоставляет интерактивности, масштабирования и контекстной информации (например, высоты или угроз).

## 2. Основные задачи (бэклог на фазу 3)

### 2.1. Stateful Track Store (P3‑001)

- Реализовать **фильтрацию и сопровождение целей** (Alpha–Beta filter) с ассоциацией детекций, созданием и удалением треков.
- Добавить **признаки трека**, включая скорость, направление, качество фильтрации и индикаторы достоверности.
- Предусмотреть **интеграцию с IFF/transponder** и сохранение этих атрибутов на уровне трека (см. `docs/radar_phase2_roadmap.md`, `docs/analysis/radar_track_store_design.md`).

### 2.2. Guard Rules и интеграция с FSM (P3‑002)

- Парсинг файла `guard_rules.yaml` и генерация объектов правил.
- Интеграция правил с FSM и WorldModel: проверка нарушений, генерация событий тревоги, экспорт метрик.
- Возможность настроить разные уровни оповещений (например, «неизвестная цель», «отключённый транспондер в опасной зоне» и т. п.).

### 2.3. UI визуализации радара (P3‑003)

- **Реальное время:** отображение текущего кадра и списка активных треков в виде таблицы или панели, с сортировкой, фильтрами и поиском.
- **Масштабирование / zoom:** возможность изменять масштаб и рамки отображения, переключать дальнобойный/короткобойный диапазоны.
- **Оверлеи guard‑правил:** нанесение границ ограниченных зон и выделение нарушителей на графике.
- **Информативность:** вывод задержек обработки, счётчиков треков/детекций, уровня сигнала (SNR), качества фильтрации, состояния ответчика (mode 3 A/C), оценок угрозы и т.п.
- **Управление:** переключатель потоков LR/SR, фильтр по режиму ответчика, настройка порогов качества треков, управление воспроизведением (pause/resume, шаг по кадрам).
- **Используемые технологии:** предлагается задействовать библиотеки для интерактивной графики (*Dash*, *Plotly* или Pillow + протоколы Kitty/Sixel) для создания масштабируемого 2D/3D‑отображения.

## 3. Стратегии визуализации

### 3.1. Отказ от ASCII-графики

Текущая реализация радара рисует изображение в текстовом режиме (ASCII) (см. `src/qiki/services/operator_console/ui/charts.py`). Для полноценного интерфейса необходимо перейти на **графический рендеринг** в терминале (Kitty/Sixel) или web‑интерфейсе (Dash/Plotly). Это позволит:

- выводить **точные окружности и линии**, поддерживая масштабирование;
- отображать **иконки целей** и подписи (идентификатор, скорость, высота);
- внедрить **цветовую кодировку** для различных типов объектов и уровней угроз;
- добавить **3D‑эффекты** (например, перспективу или наклонную проекцию) для отражения высоты.

### 3.2. Камера и проекции

Для 3D‑отображения предлагается реализовать **абстракцию камеры**:

- параметры: положение (x, y, z), угол поворота (yaw), наклон (pitch), поле зрения (fov) и масштаб;
- поддержка разных режимов: PPI (вид сверху), oblique (наклонный), forward (конус обзора).

Этот уровень отделяет математику проекции от UI и обеспечивает гибкую смену перспективы без изменения модели данных.

### 3.3. Интерактивный интерфейс

Исходя из исследованных TUI‑паттернов, интерфейс следует строить по принципу:

- **многопанельный**: таблица треков слева, графический радар справа, снизу — командная строка и логи;
- **инспектор выбранного объекта**: при выборе трека отображать подробности (координаты, скорость, IFF/код, состояние guard‑правил);
- **навигация и фильтры**: фильтр по диапазону, режиму ответчика, статусу трека; возможность перемещения по истории.

## 4. Рекомендации для повышения крепкости и полезности

1. **Завершить stateful‑track‑store** — без надёжной системы сопровождения невозможна точная визуализация и анализ.
2. **Интегрировать guard‑rules** на уровне треков: это позволит добавлять предупреждения о нарушениях прямо на радаре.
3. **Перейти на графическую визуализацию**, отказавшись от чистого ASCII. Использовать библиотеку визуализации, поддерживающую обновление 5–10 Гц и вывод изображений в терминал (Kitty/Sixel) или в web‑панели.
4. **Планомерно внедрять 3D‑проекцию** для улучшения восприятия высоты и дальности.
5. **Повысить observability**: экспортировать метрики обработки кадров, задержек, частоты обновления, качества треков и отображать их в UI.
6. **Функциональность “playback”**: возможность воспроизводить сохранённые сессии для анализа и отладки.

## 5. Заключение

Проект QIKI_DTMP уже реализует базовую обработку и передачу радарных данных. Однако для обеспечения удобной и мощной визуализации необходимо выполнить работы по созданию stateful‑трек‑стора, интеграции guard‑правил и разработке полноценного UI. Переход к графическому отображению с поддержкой масштабирования и 3D‑проекции повысит наглядность и эффективность работы оператора.
