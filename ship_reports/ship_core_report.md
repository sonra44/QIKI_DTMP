# Отчет: `services/q_core_agent/core/ship_core.py`

## Вход и цель
- [Факт] Анализ модуля управления ядром корабля для описания задач и рисков.

## Сбор контекста
- [Факт] Прочитан исходник `ship_core.py`, использующий `dataclass` для статусов систем.
- [Факт] Изучены соседние тесты `test_ship_diagnostics.py`, `test_ship_fsm.py`.
- [Гипотеза] Модуль предполагается частью сервисного агента QIKI.

## Локализация артефакта
- [Факт] Путь: `services/q_core_agent/core/ship_core.py` внутри архива `QIKI_DTMP.zip`.
- [Факт] Требует Python 3 и сгенерированные protobuf-классы в `generated/`.

## Фактический разбор
- [Факт] Объявлены датаклассы для статусов: `HullStatus`, `PowerSystemStatus`, `PropulsionStatus`, `SensorStatus`, `LifeSupportStatus`, `ComputingStatus`.
- [Факт] Класс `ShipCore` загружает конфигурацию JSON, создает идентификатор и предоставляет методы `get_*_status`.
- [Факт] Поддерживаются callbacks сенсоров и отправка команд актуаторам с валидацией ID.
- [Факт] Метод `get_ship_summary` агрегирует ключевые показатели корабля.

## Роль в системе и связи
- [Факт] Используется в `ship_fsm_handler.py` и тестах как источник статусов.
- [Гипотеза] Вызывается другими сервисами агента для мониторинга и управления.

## Несоответствия и риски
- [Факт] Нет обработчика исключений при чтении датчиков в `_process_incoming_sensor_data` (Low).
- [Гипотеза] Отсутствует механизм синхронизации при одновременных обращениях (Med).
- [Факт] В `send_actuator_command` сравнительные ID преобразуются вручную — риск ошибок (Med).

## Мини-патчи (safe-fix)
- [Патч] Добавить try/except в `_process_incoming_sensor_data` для устойчивости.
- [Патч] В `send_actuator_command` использовать множество для `all_systems` и нормализацию строк.

## Рефактор-скетч
```python
# Псевдокод
systems = {s.id for s in config.sensors}
if cmd.id not in systems:
    raise ValueError
```

## Примеры использования
```python
from ship_core import ShipCore
ship = ShipCore(base_path="./")
status = ship.get_power_status()
print(status.reactor_output_mw)
```

## Тест-хуки/чек-лист
- [Факт] Юнит: проверка генерации ID.
- [Факт] Интеграция: `send_actuator_command` отклоняет неизвестный ID.

## Вывод
- [Факт] Модуль стабильно предоставляет статусы и идентификацию.
- [Гипотеза] Для устойчивости добавить обработку ошибок и нормализацию идентификаторов.
- [Патч] Реализовать защиту при параллельных вызовах позже.
